<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>自定义 POD 调度 Scheduling Framework - Lain Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="自定义 POD 调度 Scheduling Framework"><meta property="og:description" content="kube-scheduler 是 kubernetes 的核心组件之一，主要负责整个集群资源的调度功能，根据特定的调度算法和策略，将 Pod 调度到最优的工作节点上面去，从而更加合理、更加充分的利用"><meta property="og:type" content="article"><meta property="og:url" content="http://xuliangtang.github.io/posts/scheduling-framework/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-26T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-26T22:41:49+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="自定义 POD 调度 Scheduling Framework"><meta name=twitter:description content="kube-scheduler 是 kubernetes 的核心组件之一，主要负责整个集群资源的调度功能，根据特定的调度算法和策略，将 Pod 调度到最优的工作节点上面去，从而更加合理、更加充分的利用"><meta name=application-name content="Lain Blog"><meta name=apple-mobile-web-app-title content="Lain Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://xuliangtang.github.io/posts/scheduling-framework/><link rel=prev href=http://xuliangtang.github.io/posts/fluent-bit/><link rel=next href=http://xuliangtang.github.io/posts/grpc/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"自定义 POD 调度 Scheduling Framework","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/xuliangtang.github.io\/posts\/scheduling-framework\/"},"genre":"posts","wordcount":4212,"url":"http:\/\/xuliangtang.github.io\/posts\/scheduling-framework\/","datePublished":"2023-02-26T00:00:00+00:00","dateModified":"2023-02-26T22:41:49+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xuliangTang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">自定义 POD 调度 Scheduling Framework</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xuliangTang</a></span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-02-26>2023-02-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;4212 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#调度框架>调度框架</a></li><li><a href=#扩展点>扩展点</a></li><li><a href=#基本示例>基本示例</a><ul><li><a href=#filter-过滤节点>Filter 过滤节点</a></li><li><a href=#prescore-预打分>PreScore 预打分</a></li><li><a href=#score-打分>Score 打分</a></li><li><a href=#permit-阶段>Permit 阶段</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>kube-scheduler 是 kubernetes 的核心组件之一，主要负责整个集群资源的调度功能，根据特定的调度算法和策略，将 Pod 调度到最优的工作节点上面去，从而更加合理、更加充分的利用集群的资源</p><p>Kubernetes v1.15 版本中引入了可插拔架构的调度框架，调库框架向现有的调度器中添加了一组插件化的 API，该 API 在保持调度程序“核心”简单且易于维护的同时，使得大部分的调度功能以插件的形式存在，参考文档：<a href=https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/scheduling-framework/ target=_blank rel="noopener noreffer">调度框架</a></p><h2 id=调度框架>调度框架</h2><p>调度框架定义了一组扩展点，用户可以实现扩展点定义的接口来定义自己的调度逻辑（我们称之为<strong>扩展</strong>），并将扩展注册到扩展点上，调度框架在执行调度工作流时，遇到对应的扩展点时，将调用用户注册的扩展。调度框架在预留扩展点时，都是有特定的目的，有些扩展点上的扩展可以改变调度程序的决策方法，有些扩展点上的扩展只是发送一个通知</p><p>我们知道每当调度一个 Pod 时，都会按照两个过程来执行：<strong>调度过程</strong>和<strong>绑定过程</strong></p><p>调度过程为 Pod 选择一个合适的节点，绑定过程则将调度过程的决策应用到集群中（也就是在被选定的节点上运行 Pod），将调度过程和绑定过程合在一起，称之为<strong>调度上下文（scheduling context）</strong>。需要注意的是调度过程是<code>同步</code>运行的（同一时间点只为一个 Pod 进行调度），绑定过程可异步运行（同一时间点可并发为多个 Pod 执行绑定）</p><p>调度过程和绑定过程遇到如下情况时会中途退出：</p><ul><li>调度程序认为当前没有该 Pod 的可选节点</li><li>内部错误</li></ul><p>这个时候，该 Pod 将被放回到 <strong>待调度队列</strong>，并等待下次重试</p><h2 id=扩展点>扩展点</h2><p>下图展示了调度框架中的调度上下文及其中的扩展点，一个扩展可以注册多个扩展点，以便可以执行更复杂的有状态的任务，参考：<a href=https://kubernetes.io/zh-cn/docs/reference/scheduling/config/ target=_blank rel="noopener noreffer">调度器配置</a></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302261944744.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302261944744.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302261944744.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302261944744.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302261944744.png title=img></p><ol><li><code>QueueSort</code> 扩展用于对 Pod 的待调度队列进行排序，以决定先调度哪个 Pod，<code>QueueSort</code> 扩展本质上只需要实现一个方法 <code>Less(Pod1, Pod2)</code> 用于比较两个 Pod 谁更优先获得调度即可，同一时间点只能有一个 <code>QueueSort</code> 插件生效</li><li><code>Pre-filter</code> 扩展用于对 Pod 的信息进行预处理，或者检查一些集群或 Pod 必须满足的前提条件，如果 <code>pre-filter</code> 返回了 error，则调度过程终止</li><li><code>Filter</code> 扩展用于排除那些不能运行该 Pod 的节点，对于每一个节点，调度器将按顺序执行 <code>filter</code> 扩展；如果任何一个 <code>filter</code> 将节点标记为不可选，则余下的 <code>filter</code> 扩展将不会被执行。调度器可以同时对多个节点执行 <code>filter</code> 扩展</li><li><code>Post-filter</code> 是一个通知类型的扩展点，调用该扩展的参数是 <code>filter</code> 阶段结束后被筛选为<strong>可选节点</strong>的节点列表，可以在扩展中使用这些信息更新内部状态，或者产生日志或 metrics 信息</li><li><code>PreScore</code> 扩展用于执行 “前置评分（pre-scoring）” 工作，即生成一个可共享状态供 Score 插件使用。 如果 PreScore 插件返回错误，则调度周期将终止</li><li><code>Score</code> 评分插件用于对通过过滤阶段的节点进行排名。调度器为每个节点调用每个评分插件。 将有一个定义明确的整数范围，代表最小和最大分数。 在标准化评分阶段之后，调度器将根据配置的插件权重 合并所有插件的节点分数</li><li><code>NormalizeScore</code> 扩展在调度器对节点进行最终排序之前修改每个节点的评分结果，注册到该扩展点的扩展在被调用时，将获得同一个插件中的 <code>scoring</code> 扩展的评分结果作为参数，调度框架每执行一次调度，都将调用所有插件中的一个 <code>normalize scoring</code> 扩展一次</li><li><code>Reserve</code> 是一个通知性质的扩展点，有状态的插件可以使用该扩展点来获得节点上为 Pod 预留的资源，该事件发生在调度器将 Pod 绑定到节点之前，目的是避免调度器在等待 Pod 与节点绑定的过程中调度新的 Pod 到节点上时，发生实际使用资源超出可用资源的情况。（因为绑定 Pod 到节点上是异步发生的）。这是调度过程的最后一个步骤，Pod 进入 reserved 状态以后，要么在绑定失败时触发 Unreserve 扩展，要么在绑定成功时，由 Post-bind 扩展结束绑定过程</li><li><code>Permit</code> 扩展在每个 Pod 调度周期的最后调用，用于阻止或者延迟 Pod 与节点的绑定。Permit 扩展可以做下面三件事中的一项：<ul><li>approve（批准）：当所有的 permit 扩展都 approve 了 Pod 与节点的绑定，调度器将继续执行绑定过程</li><li>deny（拒绝）：如果任何一个 permit 扩展 deny 了 Pod 与节点的绑定，Pod 将被放回到待调度队列，此时将触发 <code>Unreserve</code> 扩展</li><li>wait（等待）：如果一个 permit 扩展返回了 wait，则 Pod 将保持在 permit 阶段，同时该 Pod 的绑定周期启动时即直接阻塞直到得到批准，如果超时事件发生，wait 状态变成 deny，Pod 将被放回到待调度队列，此时将触发 Unreserve 扩展</li></ul></li><li><code>Pre-bind</code> 扩展用于在 Pod 绑定之前执行某些逻辑。例如，pre-bind 扩展可以将一个基于网络的数据卷挂载到节点上，以便 Pod 可以使用。如果任何一个 <code>pre-bind</code> 扩展返回错误，Pod 将被放回到待调度队列，此时将触发 Unreserve 扩展</li><li><code>Bind</code> 扩展用于将 Pod 绑定到节点上：<ul><li>只有所有的 pre-bind 扩展都成功执行了，bind 扩展才会执行</li><li>调度框架按照 bind 扩展注册的顺序逐个调用 bind 扩展</li><li>具体某个 bind 扩展可以选择处理或者不处理该 Pod</li><li>如果某个 bind 扩展处理了该 Pod 与节点的绑定，余下的 bind 扩展将被忽略</li><li>如果失败，则执行 Unreverse 扩展点将预先消费的资源释放掉(如 PVC 和 PV)，并将 Pod 从调度队列中删除</li></ul></li><li><code>Post-bind</code> 是一个通知性质的扩展，是整个调度的最后一步：<ul><li>Post-bind 扩展在 Pod 成功绑定到节点上之后被动调用</li><li>Post-bind 扩展是绑定过程的最后一个步骤，可以用来执行资源清理的动作</li></ul></li><li><code>Unreserve</code> 是一个通知性质的扩展，如果为 Pod 预留了资源，Pod 又在被绑定过程中被拒绝绑定，则 unreserve 扩展将被调用。Unreserve 扩展应该释放已经为 Pod 预留的节点上的计算资源。在一个插件中，reserve 扩展和 unreserve 扩展应该成对出现</li></ol><p>官方实现了一些扩展点插件：<a href=https://github.com/kubernetes/kubernetes/tree/master/pkg/scheduler/framework/plugins target=_blank rel="noopener noreffer">kubernetes/pkg/scheduler/framework/plugins</a></p><p>如果我们要实现自己的插件，必须向调度框架注册插件并完成配置，另外还必须实现扩展点接口，参考项目：<a href=https://github.com/kubernetes-sigs/scheduler-plugins target=_blank rel="noopener noreffer">kubernetes-sigs/scheduler-plugins</a></p><p>扩展的调用顺序如下：</p><ul><li>如果某个扩展点没有配置对应的扩展，调度框架将使用默认插件中的扩展</li><li>如果为某个扩展点配置且激活了扩展，则调度框架将先调用默认插件的扩展，再调用配置中的扩展</li><li>默认插件的扩展始终被最先调用，然后按照 <code>KubeSchedulerConfiguration</code> 中扩展的激活 <code>enabled</code> 顺序逐个调用扩展点的扩展</li><li>可以先禁用默认插件的扩展，然后在 <code>enabled</code> 列表中的某个位置激活默认插件的扩展，这种做法可以改变默认插件的扩展被调用时的顺序</li></ul><h2 id=基本示例>基本示例</h2><p>下面是一个实现 <strong>PreFilter</strong> 扩展点示例，用来限制命名空间内 POD 最大调度数量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// go.mod
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nf>require</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>api</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>apimachinery</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>component</span><span class=o>-</span><span class=nx>base</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>klog</span><span class=o>/</span><span class=nx>v2</span> <span class=nx>v2</span><span class=mf>.9.0</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>scheduler</span> <span class=nx>v0</span><span class=mf>.22.3</span> <span class=c1>// indirect
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kubernetes</span> <span class=nx>v1</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>replace</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>api</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>api</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>apiextensions</span><span class=o>-</span><span class=nx>apiserver</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>apiextensions</span><span class=o>-</span><span class=nx>apiserver</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>apimachinery</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>apimachinery</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>apiserver</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>apiserver</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cli</span><span class=o>-</span><span class=nx>runtime</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cli</span><span class=o>-</span><span class=nx>runtime</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>client</span><span class=o>-</span><span class=k>go</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>client</span><span class=o>-</span><span class=k>go</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cloud</span><span class=o>-</span><span class=nx>provider</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cloud</span><span class=o>-</span><span class=nx>provider</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cluster</span><span class=o>-</span><span class=nx>bootstrap</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cluster</span><span class=o>-</span><span class=nx>bootstrap</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>code</span><span class=o>-</span><span class=nx>generator</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>code</span><span class=o>-</span><span class=nx>generator</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>component</span><span class=o>-</span><span class=nx>base</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>component</span><span class=o>-</span><span class=nx>base</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>component</span><span class=o>-</span><span class=nx>helpers</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>component</span><span class=o>-</span><span class=nx>helpers</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>controller</span><span class=o>-</span><span class=nx>manager</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>controller</span><span class=o>-</span><span class=nx>manager</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cri</span><span class=o>-</span><span class=nx>api</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cri</span><span class=o>-</span><span class=nx>api</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>csi</span><span class=o>-</span><span class=nx>translation</span><span class=o>-</span><span class=nx>lib</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>csi</span><span class=o>-</span><span class=nx>translation</span><span class=o>-</span><span class=nx>lib</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>aggregator</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>aggregator</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>controller</span><span class=o>-</span><span class=nx>manager</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>controller</span><span class=o>-</span><span class=nx>manager</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>proxy</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>proxy</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>scheduler</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>scheduler</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kubectl</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kubectl</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kubelet</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kubelet</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kubernetes</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>kubernetes</span> <span class=nx>v1</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>legacy</span><span class=o>-</span><span class=nx>cloud</span><span class=o>-</span><span class=nx>providers</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>legacy</span><span class=o>-</span><span class=nx>cloud</span><span class=o>-</span><span class=nx>providers</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>metrics</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>metrics</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>mount</span><span class=o>-</span><span class=nx>utils</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>mount</span><span class=o>-</span><span class=nx>utils</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>pod</span><span class=o>-</span><span class=nx>security</span><span class=o>-</span><span class=nx>admission</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>pod</span><span class=o>-</span><span class=nx>security</span><span class=o>-</span><span class=nx>admission</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>sample</span><span class=o>-</span><span class=nx>apiserver</span> <span class=p>=&gt;</span> <span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>sample</span><span class=o>-</span><span class=nx>apiserver</span> <span class=nx>v0</span><span class=mf>.22.3</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// main.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/component-base/logs&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/kubernetes/cmd/kube-scheduler/app&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;pod-scheduler/lib&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>command</span> <span class=o>:=</span> <span class=nx>app</span><span class=p>.</span><span class=nf>NewSchedulerCommand</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>app</span><span class=p>.</span><span class=nf>WithPlugin</span><span class=p>(</span><span class=nx>lib</span><span class=p>.</span><span class=nx>TestSchedulingName</span><span class=p>,</span> <span class=nx>lib</span><span class=p>.</span><span class=nx>NewTestScheduler</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>logs</span><span class=p>.</span><span class=nf>InitLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>logs</span><span class=p>.</span><span class=nf>FlushLogs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>command</span><span class=p>.</span><span class=nf>Execute</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>_</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Stdout</span><span class=p>,</span> <span class=s>&#34;%v\n&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// lib/test-scheduling.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>coreV1</span> <span class=s>&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/labels&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/informers&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/klog/v2&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/kubernetes/pkg/scheduler/framework&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>frameworkRuntime</span> <span class=s>&#34;k8s.io/kubernetes/pkg/scheduler/framework/runtime&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>TestSchedulingName</span> <span class=p>=</span> <span class=s>&#34;TestScheduling&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>TestScheduler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fact</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span>
</span></span><span class=line><span class=cl>	<span class=nx>args</span> <span class=o>*</span><span class=nx>Args</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Args</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>MaxPods</span> <span class=kt>int</span> <span class=s>`json:&#34;maxPods,omitempty&#34;`</span>	<span class=c1>// 最大调度数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>AddPod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>podToSchedule</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>podInfoToAdd</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>PodInfo</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>RemovePod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>podToSchedule</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>podInfoToRemove</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>PodInfo</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>PreFilter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>p</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 业务逻辑实现
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;当前被preFilter的POD名称是：%s\n&#34;</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>pods</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>fact</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Lister</span><span class=p>().</span><span class=nf>Pods</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>labels</span><span class=p>.</span><span class=nf>Everything</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>args</span><span class=p>.</span><span class=nx>MaxPods</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pods</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>s</span><span class=p>.</span><span class=nx>args</span><span class=p>.</span><span class=nx>MaxPods</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Unschedulable</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;POD数量超过上限%d&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>args</span><span class=p>.</span><span class=nx>MaxPods</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>PreFilterExtensions</span><span class=p>()</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>PreFilterExtensions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>s</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>Name</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>TestSchedulingName</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>PreFilterPlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>TestScheduler</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewTestScheduler</span><span class=p>(</span><span class=nx>configuration</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span> <span class=nx>handle</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Handle</span><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Plugin</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>args</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Args</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 得到调度插件自定义参数，反编码为struct
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>frameworkRuntime</span><span class=p>.</span><span class=nf>DecodeInto</span><span class=p>(</span><span class=nx>configuration</span><span class=p>,</span> <span class=nx>args</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>TestScheduler</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fact</span><span class=p>:</span> <span class=nx>handle</span><span class=p>.</span><span class=nf>SharedInformerFactory</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>args</span><span class=p>:</span> <span class=nx>args</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然后可以当成普通的应用用一个 Deployment 控制器来部署即可，由于我们需要去获取集群中的一些资源对象，所以当然需要申请 RBAC 权限，然后同样通过 <code>--config</code> 参数来配置我们的调度器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-clusterrole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>create</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>delete</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>bindings</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>pods/binding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>create</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>pods/status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>patch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>replicationcontrollers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>apps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>extensions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>replicasets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>apps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>statefulsets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>policy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>poddisruptionbudgets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>persistentvolumeclaims</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>persistentvolumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>namespaces</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;storage.k8s.io&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;*&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;coordination.k8s.io&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>leases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>create</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;events.k8s.io&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>events</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>create</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>patch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-clusterrolebinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-clusterrole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    apiVersion: kubescheduler.config.k8s.io/v1beta2
</span></span></span><span class=line><span class=cl><span class=sd>    kind: KubeSchedulerConfiguration
</span></span></span><span class=line><span class=cl><span class=sd>    leaderElection:
</span></span></span><span class=line><span class=cl><span class=sd>      leaderElect: false
</span></span></span><span class=line><span class=cl><span class=sd>    profiles:
</span></span></span><span class=line><span class=cl><span class=sd>      - schedulerName: test-scheduling
</span></span></span><span class=line><span class=cl><span class=sd>        plugins:
</span></span></span><span class=line><span class=cl><span class=sd>          preFilter:
</span></span></span><span class=line><span class=cl><span class=sd>            enabled:
</span></span></span><span class=line><span class=cl><span class=sd>            - name: &#34;TestScheduling&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        pluginConfig:
</span></span></span><span class=line><span class=cl><span class=sd>        - name: TestScheduling
</span></span></span><span class=line><span class=cl><span class=sd>          args:
</span></span></span><span class=line><span class=cl><span class=sd>            maxPods: 17		# 调度插件自定义参数</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class=l>lain1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccount</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tests-cheduling</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>alpine:3.12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/app/test-scheduling&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- --<span class=l>config=/etc/kubernetes/config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- --<span class=l>v=3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/kubernetes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/home/txl/pod-scheduler</span><span class=w>
</span></span></span></code></pre></div><p>部署一个测试 pod</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>testngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>testngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling	# 使用指定scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.18-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><h3 id=filter-过滤节点>Filter 过滤节点</h3><p>不允许调度到存在 noScheduling=true 标签的节点上</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// lib/test-scheduling.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>FilterPlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>TestScheduler</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>Filter</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeInfo</span><span class=p>.</span><span class=nf>Node</span><span class=p>().</span><span class=nx>Labels</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>k</span> <span class=o>==</span> <span class=s>&#34;noScheduling&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>v</span> <span class=o>==</span> <span class=s>&#34;true&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Unschedulable</span><span class=p>,</span> <span class=s>&#34;该节点不可调度&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>加入 filter 调度配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-scheduling-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    apiVersion: kubescheduler.config.k8s.io/v1beta2
</span></span></span><span class=line><span class=cl><span class=sd>    kind: KubeSchedulerConfiguration
</span></span></span><span class=line><span class=cl><span class=sd>    leaderElection:
</span></span></span><span class=line><span class=cl><span class=sd>      leaderElect: false
</span></span></span><span class=line><span class=cl><span class=sd>    profiles:
</span></span></span><span class=line><span class=cl><span class=sd>      - schedulerName: test-scheduling
</span></span></span><span class=line><span class=cl><span class=sd>        plugins:
</span></span></span><span class=line><span class=cl><span class=sd>          preFilter:
</span></span></span><span class=line><span class=cl><span class=sd>            enabled:
</span></span></span><span class=line><span class=cl><span class=sd>            - name: &#34;TestScheduling&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          filter:
</span></span></span><span class=line><span class=cl><span class=sd>            enabled:
</span></span></span><span class=line><span class=cl><span class=sd>            - name: &#34;TestScheduling&#34;
</span></span></span><span class=line><span class=cl><span class=sd>        pluginConfig:
</span></span></span><span class=line><span class=cl><span class=sd>        - name: TestScheduling
</span></span></span><span class=line><span class=cl><span class=sd>          args:
</span></span></span><span class=line><span class=cl><span class=sd>            maxPods: 17</span><span class=w>    
</span></span></span></code></pre></div><h3 id=prescore-预打分>PreScore 预打分</h3><p>该阶段能得到 Filter 阶段结束后的 Node 列表，在这里我们可以做些预处理并保存到 CycleState（主要负责调度流程中”一些数据”的保存， framework 中所有的插件均可进行数据增加和修改， 线程安全）给后续插件进行流转</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// lib/test-scheduling.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>PreScorePlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>TestScheduler</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>NodeMemory</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>data</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>float64</span> <span class=c1>// 内存空闲
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>n</span> <span class=o>*</span><span class=nx>NodeMemory</span><span class=p>)</span> <span class=nf>Clone</span><span class=p>()</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>StateData</span> <span class=p>{</span>	<span class=c1>// 实现StateData接口
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>NodeMemory</span><span class=p>{</span><span class=nx>data</span><span class=p>:</span> <span class=nx>n</span><span class=p>.</span><span class=nx>data</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>PreScore</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodes</span> <span class=p>[]</span><span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Node</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>memory</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>NodeMemory</span><span class=p>{</span><span class=nx>data</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>float64</span><span class=p>{}}</span>
</span></span><span class=line><span class=cl>	<span class=nx>memory</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=s>&#34;node1&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=mf>0.3</span>
</span></span><span class=line><span class=cl>	<span class=nx>memory</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=s>&#34;node2&#34;</span><span class=p>]</span> <span class=p>=</span> <span class=mf>0.4</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=s>&#34;nodeMemory&#34;</span><span class=p>,</span> <span class=nx>memory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;预打分阶段：保存数据成功&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>加入 filter 调度配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>preScore</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TestScheduling&#34;</span><span class=w>
</span></span></span></code></pre></div><p>然后就可以在后续扩展点通过 <code>getNodeMemory, err := state.Read("nodeMemory")</code> 获取值</p><h3 id=score-打分>Score 打分</h3><p>最终的分数需要在 [MinNodeScore，MaxNodeScore]（[0-100]）之间，为了防止分数超出，需要做归一化（Min-Max Normalization ）处理，这是最常见的 min-max 归一化公式
$$
X_{nom} = \frac{X - X_{min}}{X_{max} - X_{min}}
$$
也称为离差标准化，是对原始数据的线性变换，使结果值映射到 [min- max]之间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// lib/test-scheduling.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ScorePlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>TestScheduler</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>Score</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>p</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>int64</span><span class=p>,</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>nodeName</span> <span class=o>==</span> <span class=s>&#34;lain2&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=mi>30</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=mi>20</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Success</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>ScoreExtensions</span><span class=p>()</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ScoreExtensions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>s</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>NormalizeScore</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>p</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>scores</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScoreList</span><span class=p>)</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>min</span><span class=p>,</span> <span class=nx>max</span> <span class=kt>int64</span> <span class=p>=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 求出最小分数和最大分数区间
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>score</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scores</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>score</span><span class=p>.</span><span class=nx>Score</span> <span class=p>&lt;</span> <span class=nx>min</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>min</span> <span class=p>=</span> <span class=nx>score</span><span class=p>.</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>score</span><span class=p>.</span><span class=nx>Score</span> <span class=p>&gt;</span> <span class=nx>max</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>max</span> <span class=p>=</span> <span class=nx>score</span><span class=p>.</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>max</span> <span class=o>==</span> <span class=nx>min</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>min</span> <span class=p>=</span> <span class=nx>min</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>score</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scores</span> <span class=p>{</span>	<span class=c1>// 每个节点的分数归一化处理
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=p>=</span> <span class=p>(</span><span class=nx>score</span><span class=p>.</span><span class=nx>Score</span> <span class=o>-</span> <span class=nx>min</span><span class=p>)</span> <span class=o>*</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>MaxNodeScore</span> <span class=o>/</span> <span class=p>(</span><span class=nx>max</span> <span class=o>-</span> <span class=nx>min</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;节点: %v, Score: %v   Pod:  %v&#34;</span><span class=p>,</span> <span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>scores</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Success</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>加入 filter 调度配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>score</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TestScheduling&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=permit-阶段>Permit 阶段</h3><p>判断前置 POD 如果不存在，则等待10s，超时后后重新入列</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// lib/test-scheduling.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>_</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>PermitPlugin</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>TestScheduler</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>TestScheduler</span><span class=p>)</span> <span class=nf>Permit</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>p</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=nx>nodeName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Status</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nx>fact</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Lister</span><span class=p>().</span><span class=nf>Pods</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;prepose_pod&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Permit：等待10秒&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Wait</span><span class=p>),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=o>*</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>Info</span><span class=p>(</span><span class=s>&#34;Permit：通过&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewStatus</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Success</span><span class=p>),</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>加入 filter 调度配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>permit</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;TestScheduling&#34;</span><span class=w>
</span></span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-26&nbsp;<a class=git-hash href=https://github.com/xuliangTang/xuliangTang.github.io/commit/e33417c4e5457fff49df32719c10709edfcceb6a target=_blank title="commit by Lain(1297441127@qq.com) e33417c4e5457fff49df32719c10709edfcceb6a: feat: enable katex math">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>e33417c</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://xuliangtang.github.io/posts/scheduling-framework/ data-title="自定义 POD 调度 Scheduling Framework"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://xuliangtang.github.io/posts/scheduling-framework/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://xuliangtang.github.io/posts/scheduling-framework/ data-title="自定义 POD 调度 Scheduling Framework"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://xuliangtang.github.io/posts/scheduling-framework/ data-title="自定义 POD 调度 Scheduling Framework"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://xuliangtang.github.io/posts/scheduling-framework/ data-title="自定义 POD 调度 Scheduling Framework"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/fluent-bit/ class=prev rel=prev title="Fluent Bit 日志收集"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Fluent Bit 日志收集</a>
<a href=/posts/grpc/ class=next rel=next title="GO 使用 gRPC">GO 使用 gRPC<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.108.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xuliangTang</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"4ZKRIKL2L6",algoliaIndex:"dev_lain",algoliaSearchKey:"2da9b5e339083fde5fe030c2345f5499",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:80,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>