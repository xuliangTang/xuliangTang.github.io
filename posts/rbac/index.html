<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>K8s 认证和授权 - Lain Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="K8s 认证和授权"><meta property="og:description" content="文档：使用 RBAC 鉴权 | Kubernetes 用户 UserAccount（普通用户）：集群外部访问时使用的用户账号，最常见的就是 kubectl 命令就是作为 kubernetes-admin 用户来执行，k8s本身"><meta property="og:type" content="article"><meta property="og:url" content="http://xuliangtang.github.io/posts/rbac/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-03T00:00:00+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="K8s 认证和授权"><meta name=twitter:description content="文档：使用 RBAC 鉴权 | Kubernetes 用户 UserAccount（普通用户）：集群外部访问时使用的用户账号，最常见的就是 kubectl 命令就是作为 kubernetes-admin 用户来执行，k8s本身"><meta name=application-name content="Lain Blog"><meta name=apple-mobile-web-app-title content="Lain Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://xuliangtang.github.io/posts/rbac/><link rel=prev href=http://xuliangtang.github.io/posts/kubeadm/><link rel=next href=http://xuliangtang.github.io/posts/pod/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"K8s 认证和授权","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/xuliangtang.github.io\/posts\/rbac\/"},"genre":"posts","wordcount":1551,"url":"http:\/\/xuliangtang.github.io\/posts\/rbac\/","datePublished":"2022-12-03T00:00:00+00:00","dateModified":"2022-12-03T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xuliangTang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">K8s 认证和授权</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xuliangTang</a></span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-12-03>2022-12-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1551 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#用户>用户</a></li><li><a href=#用户认证>用户认证</a><ul><li><a href=#a-使用-x509-客户证书>A. 使用 X509 客户证书</a></li><li><a href=#b-使用静态令牌文件token>B. 使用静态令牌文件(Token)</a></li></ul></li><li><a href=#资源>资源</a></li><li><a href=#role-和-rolebinding>Role 和 RoleBinding</a><ul><li><a href=#创建-role>创建 Role</a></li><li><a href=#绑定-rolebinding>绑定 RoleBinding</a></li></ul></li><li><a href=#clusterrole-和-clusterrolebinding>ClusterRole 和 ClusterRoleBinding</a><ul><li><a href=#创建-clusterrole>创建 ClusterRole</a></li><li><a href=#绑定-rolebinding-1>绑定 RoleBinding</a></li><li><a href=#绑定-clusterrolebinding>绑定 ClusterRoleBinding</a></li></ul></li><li><a href=#serviceaccount>ServiceAccount</a><ul><li><a href=#创建-sa>创建 SA</a></li><li><a href=#绑定-clusterrolebinding-1>绑定 ClusterRoleBinding</a></li><li><a href=#外部访问-api>外部访问 API</a></li><li><a href=#在-pod-里访问-api>在 Pod 里访问 API</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>文档：<a href=https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/ target=_blank rel="noopener noreffer">使用 RBAC 鉴权 | Kubernetes</a></p><h2 id=用户>用户</h2><ul><li>UserAccount（普通用户）：集群外部访问时使用的用户账号，最常见的就是 <code>kubectl</code> 命令就是作为 kubernetes-admin 用户来执行，k8s本身不记录这些账号</li><li>ServiceAccount（服务账户）：它们被绑定到特定的名字空间，服务账号与一组以 Secret 保存的凭据相关，这些凭据会被挂载到 Pod 中，从而允许集群内的进程访问 Kubernetes API</li></ul><h2 id=用户认证>用户认证</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203231927703.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203231927703.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203231927703.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203231927703.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203231927703.png title=image-20221203231927703></p><h3 id=a-使用-x509-客户证书>A. 使用 X509 客户证书</h3><h4 id=生成证书>生成证书</h4><p>安装 OpenSSL</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo yum install openssl openssl-devel
</span></span></code></pre></div><p>生成一个名称为txl的普通用户的客户端证书</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mkdir ua/txl
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> ua/txl
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成客户端私钥</span>
</span></span><span class=line><span class=cl>$ openssl genrsa -out client.key <span class=m>2048</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 根据私钥生成csr, 指定用户名txl</span>
</span></span><span class=line><span class=cl>$ openssl req -new -key client.key -out client.csr -subj <span class=s2>&#34;/CN=txl&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 根据k8s的CA证书生成客户端证书</span>
</span></span><span class=line><span class=cl>$ sudo openssl x509 -req -in client.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out client.crt -days <span class=m>365</span>
</span></span></code></pre></div><h4 id=证书反解>证书反解</h4><p>获取证书设置的CN(Common name)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ openssl x509 -noout -subject -in client.crt
</span></span></code></pre></div><h4 id=使用证书初步请求api>使用证书初步请求API</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get endpoints
</span></span><span class=line><span class=cl>NAME         ENDPOINTS            AGE
</span></span><span class=line><span class=cl>kubernetes   192.168.0.111:6443   4d5h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl --cert ./client.crt --key ./client.key --cacert /etc/kubernetes/pki/ca.crt -s https://192.168.0.111:6443/api
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;APIVersions&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;versions&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;v1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;serverAddressByClientCIDRs&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;clientCIDR&#34;</span>: <span class=s2>&#34;0.0.0.0/0&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;serverAddress&#34;</span>: <span class=s2>&#34;192.168.0.111:6443&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>可以使用 <code>--insecure</code> 代替 <code>--cacert /etc/kubernetes/pki/ca.crt</code> 忽略服务端证书验证</p><h4 id=证书加入-kube-config>证书加入 kube config</h4><p>把 client.crt 加入到 ~/.kube/config</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl config --kubeconfig<span class=o>=</span>~/.kube/config set-credentials txl --client-certificate<span class=o>=</span>~/ua/txl/client.crt --client-key<span class=o>=</span>~/ua/txl/client.key
</span></span></code></pre></div><p>创建一个名为 user_context 的 context</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl config --kubeconfig<span class=o>=</span>~/.kube/config set-context user_context --cluster<span class=o>=</span>kubernetes --user<span class=o>=</span>txl
</span></span></code></pre></div><p>切换当前上下文为 user_context</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl config use-context user_context
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看</span>
</span></span><span class=line><span class=cl>$ kubectl config current-context
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重新切回默认管理员</span>
</span></span><span class=line><span class=cl>$ kubectl config use-context kubernetes-admin@kubernetes
</span></span></code></pre></div><h3 id=b-使用静态令牌文件token>B. 使用静态令牌文件(Token)</h3><h4 id=生成-token>生成 Token</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ head -c <span class=m>16</span> /dev/urandom <span class=p>|</span> od -An -t x <span class=p>|</span> tr -d <span class=s1>&#39; &#39;</span>
</span></span></code></pre></div><h4 id=加入-kube-config>加入 kube config</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl config set-credentials txl --token<span class=o>=</span>fdb72d94a1c2c2cfbf82341d1f98c68c
</span></span></code></pre></div><h4 id=修改-api-server-启动参数>修改 api-server 启动参数</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo vi /etc/kubernetes/pki/token_auth
</span></span><span class=line><span class=cl><span class=c1># 加入</span>
</span></span><span class=line><span class=cl>fdb72d94a1c2c2cfbf82341d1f98c68c,txl,1001
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo vi /etc/kubernetes/manifests/kube-apiserver.yaml
</span></span><span class=line><span class=cl><span class=c1># 加入</span>
</span></span><span class=line><span class=cl>--token-auth-file<span class=o>=</span>/etc/kubernetes/pki/token_auth
</span></span></code></pre></div><h4 id=查看>查看</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -H <span class=s2>&#34;Authorization: Bearer fdb72d94a1c2c2cfbf82341d1f98c68c&#34;</span> https://192.168.0.111:6443/api/v1/namespaces/default/pods --insecure
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;kind&#34;</span>: <span class=s2>&#34;PodList&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;apiVersion&#34;</span>: <span class=s2>&#34;v1&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;metadata&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;selfLink&#34;</span>: <span class=s2>&#34;/api/v1/namespaces/default/pods&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;resourceVersion&#34;</span>: <span class=s2>&#34;1586027&#34;</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;items&#34;</span>: <span class=o>[]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h2 id=资源>资源</h2><p>查看所有资源</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl api-resources -o wide
</span></span></code></pre></div><p>其中 VERBS 列展示了该资源对应的操作，比如 role</p><ul><li>create 创建</li><li>delete 删除</li><li>deletecollection 批量删除</li><li>get 获取</li><li>list 列表</li><li>patch 合并变更</li><li>update 更新</li><li>watch 监听</li></ul><h2 id=role-和-rolebinding>Role 和 RoleBinding</h2><ul><li>Role（角色）：包含一组代表相关权限的规则，用于授予对单个命名空间的资源访问</li><li>RoleBinding（角色绑定）：将角色中定义的权限赋予一个或者一组用户</li></ul><h3 id=创建-role>创建 Role</h3><p>下面是一个位于default的role，拥有对pod的读访问权限</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ vi role_mypod.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kind: Role
</span></span><span class=line><span class=cl>apiVersion: rbac.authorization.k8s.io/v1
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  namespace: default
</span></span><span class=line><span class=cl>  name: mypod
</span></span><span class=line><span class=cl>rules:
</span></span><span class=line><span class=cl>- apiGroups: <span class=o>[</span><span class=s2>&#34;*&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  resources: <span class=o>[</span><span class=s2>&#34;pods&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>  verbs: <span class=o>[</span><span class=s2>&#34;get&#34;</span>, <span class=s2>&#34;watch&#34;</span>, <span class=s2>&#34;list&#34;</span><span class=o>]</span>
</span></span></code></pre></div><p>执行创建</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f role_mypod.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看default空间所有role</span>
</span></span><span class=line><span class=cl>$ kubectl get role -n default
</span></span></code></pre></div><p>删除</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl delete role mypod -n default
</span></span></code></pre></div><h3 id=绑定-rolebinding>绑定 RoleBinding</h3><p>创建一个名为mypodbinding的 rolebinding，关联创建的用户txl和创建的角色mypod</p><h4 id=1-使用命令>1. 使用命令</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create rolebinding mypodbinding -n default --role mypod --user txl
</span></span></code></pre></div><h4 id=2-使用-yaml>2. 使用 yaml</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypodrolebinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>txl</span><span class=w>
</span></span></span></code></pre></div><p>查看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get rolebinding -n default
</span></span><span class=line><span class=cl>NAME               ROLE
</span></span><span class=line><span class=cl>mypodrolebinding   Role/mypod
</span></span></code></pre></div><p>删除</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl delete rolebinding mypodbinding -n default
</span></span></code></pre></div><h2 id=clusterrole-和-clusterrolebinding>ClusterRole 和 ClusterRoleBinding</h2><p>ClusterRole 同样可以用于授予 Role 能够授予的权限。 因为 ClusterRole 属于集群范围，所以它也可以为以下资源授予访问权限：</p><ul><li>集群范围资源（如节点 Node）</li><li>非资源端点（如 <code>/healthz</code>）</li><li>跨名字空间访问的名字空间作用域的资源（如 Pod）</li></ul><p>clusterRole不限定命名空间，绑定既可以使用 RoleBinding，也可以使用 ClusterRoleBinding</p><h3 id=创建-clusterrole>创建 ClusterRole</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><p>查看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get clusterrole
</span></span></code></pre></div><h3 id=绑定-rolebinding-1>绑定 RoleBinding</h3><p>需要指定命名空间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypodrolebinding-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>shenyi</span><span class=w>
</span></span></span></code></pre></div><p>查看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get rolebinding -n kube-system
</span></span><span class=line><span class=cl>NAME                                                ROLE
</span></span><span class=line><span class=cl>mypodrolebinding-cluster                            ClusterRole/mypod-cluster
</span></span></code></pre></div><h3 id=绑定-clusterrolebinding>绑定 ClusterRoleBinding</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod-clusterrolebinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mypod-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>txl</span><span class=w>
</span></span></span></code></pre></div><h2 id=serviceaccount>ServiceAccount</h2><p>UserAccount 是可以跨 namespace 的，而 ServiceAccount 只能局限在自己所属的 namespace 中，每个 namespace 都会有一个默认的 default 账号 。</p><h3 id=创建-sa>创建 SA</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create sa mysa
</span></span></code></pre></div><p>也可以导出到 yaml</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create sa mysa -o yaml --dry-run<span class=o>=</span>client &gt; mysa.yaml
</span></span></code></pre></div><p>查看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get sa -n default
</span></span><span class=line><span class=cl>NAME      SECRETS   AGE
</span></span><span class=line><span class=cl>default   <span class=m>1</span>         4d7h
</span></span><span class=line><span class=cl>mysa      <span class=m>1</span>         5m21s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看令牌</span>
</span></span><span class=line><span class=cl>$ kubectl describe sa mysa
</span></span><span class=line><span class=cl>Name:                mysa
</span></span><span class=line><span class=cl>Namespace:           default
</span></span><span class=line><span class=cl>Labels:              &lt;none&gt;
</span></span><span class=line><span class=cl>Annotations:         &lt;none&gt;
</span></span><span class=line><span class=cl>Image pull secrets:  &lt;none&gt;
</span></span><span class=line><span class=cl>Mountable secrets:   mysa-token-5bnbm
</span></span><span class=line><span class=cl>Tokens:              mysa-token-5bnbm
</span></span><span class=line><span class=cl>Events:              &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ kubectl describe secret mysa-token-5bnbm
</span></span></code></pre></div><h3 id=绑定-clusterrolebinding-1>绑定 ClusterRoleBinding</h3><p>使用命令的方式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create clusterrolebinding mysa-clusterrolebinding --clusterrole<span class=o>=</span>mypod-cluster --serviceaccount<span class=o>=</span>default:mysa
</span></span></code></pre></div><p>查看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get clusterrolebinding
</span></span><span class=line><span class=cl>NAME                                                   ROLE
</span></span><span class=line><span class=cl>mypod-clusterrolebinding                               ClusterRole/mypod-cluster
</span></span><span class=line><span class=cl>mysa-clusterrolebinding                                ClusterRole/mypod-cluster
</span></span></code></pre></div><h3 id=外部访问-api>外部访问 API</h3><h4 id=安装-jq>安装 jq</h4><p>轻量级的 json 处理命令。可以对 json 数据进行分片、过滤、映射、转换和格式化输出</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo yum install jq -y
</span></span></code></pre></div><h4 id=获取-sa-token>获取 SA Token</h4><p>保存到临时变量 mysatoken 中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>mysatoken</span><span class=o>=</span><span class=k>$(</span>kubectl get secret  <span class=k>$(</span>kubectl get sa  mysa -o json <span class=p>|</span> jq -Mr <span class=s1>&#39;.secrets[0].name&#39;</span><span class=k>)</span> -o json <span class=p>|</span> jq -Mr <span class=s1>&#39;.data.token&#39;</span> <span class=p>|</span> base64 -d<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看token</span>
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$mysatoken</span>
</span></span></code></pre></div><p>请求</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl -H <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$mysatoken</span><span class=s2>&#34;</span> --insecure https://192.168.0.111:6443/api/v1/namespaces/default/pods 
</span></span></code></pre></div><h3 id=在-pod-里访问-api>在 Pod 里访问 API</h3><p>创建一个测试 pod</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myngx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>mysa </span><span class=w> </span><span class=c># 指定SA，否则使用的default SA </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginxtest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.18-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></div><p>查看 pod</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get pod
</span></span><span class=line><span class=cl>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>myngx-74748c5956-5rfrs   1/1     Running   <span class=m>0</span>          4m21s
</span></span></code></pre></div><p>进入容器</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it myngx-74748c5956-5rfrs -- sh
</span></span></code></pre></div><p>设置临时变量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># SA token</span>
</span></span><span class=line><span class=cl>$ <span class=nv>TOKEN</span><span class=o>=</span><span class=sb>`</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># api server地址</span>
</span></span><span class=line><span class=cl>$ <span class=nv>APISERVER</span><span class=o>=</span><span class=s2>&#34;https://</span><span class=nv>$KUBERNETES_SERVICE_HOST</span><span class=s2>:</span><span class=nv>$KUBERNETES_PORT_443_TCP_PORT</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>请求（跳过服务器证书检查）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl --header <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$TOKEN</span><span class=s2>&#34;</span> --insecure -s <span class=nv>$APISERVER</span>/api/v1/namespaces/default/pods 
</span></span></code></pre></div><p>使用证书请求</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ curl --header <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$TOKEN</span><span class=s2>&#34;</span> --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt <span class=nv>$APISERVER</span>/api/v1/namespaces/default/pods 
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-12-03</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://xuliangtang.github.io/posts/rbac/ data-title="K8s 认证和授权"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://xuliangtang.github.io/posts/rbac/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://xuliangtang.github.io/posts/rbac/ data-title="K8s 认证和授权"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://xuliangtang.github.io/posts/rbac/ data-title="K8s 认证和授权"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://xuliangtang.github.io/posts/rbac/ data-title="K8s 认证和授权"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/kubeadm/ class=prev rel=prev title="使用 kubeadm 部署 k8s"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>使用 kubeadm 部署 k8s</a>
<a href=/posts/pod/ class=next rel=next title=Pod>Pod<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.108.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xuliangTang</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},search:{algoliaAppID:"4ZKRIKL2L6",algoliaIndex:"dev_lain",algoliaSearchKey:"2da9b5e339083fde5fe030c2345f5499",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:80,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>