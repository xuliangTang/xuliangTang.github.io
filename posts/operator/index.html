<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>使用 kubebuilder 开发 Operator - Lain Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="使用 kubebuilder 开发 Operator"><meta property="og:description" content="Operator 模式 Kubernetes 是一个高度可扩展的&#34;系统&#34;，比如常见的自定义资源，控制器，准入控制及调度器进行扩展开发等。Operator 是一种"><meta property="og:type" content="article"><meta property="og:url" content="http://xuliangtang.github.io/posts/operator/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-12T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-12T15:31:27+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 kubebuilder 开发 Operator"><meta name=twitter:description content="Operator 模式 Kubernetes 是一个高度可扩展的&#34;系统&#34;，比如常见的自定义资源，控制器，准入控制及调度器进行扩展开发等。Operator 是一种"><meta name=application-name content="Lain Blog"><meta name=apple-mobile-web-app-title content="Lain Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://xuliangtang.github.io/posts/operator/><link rel=prev href=http://xuliangtang.github.io/posts/admission-webhook/><link rel=next href=http://xuliangtang.github.io/posts/prometheus/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"使用 kubebuilder 开发 Operator","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/xuliangtang.github.io\/posts\/operator\/"},"genre":"posts","wordcount":3649,"url":"http:\/\/xuliangtang.github.io\/posts\/operator\/","datePublished":"2023-02-12T00:00:00+00:00","dateModified":"2023-02-12T15:31:27+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xuliangTang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">使用 kubebuilder 开发 Operator</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xuliangTang</a></span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-02-12>2023-02-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3649 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#operator-模式>Operator 模式</a><ul><li><a href=#operator-的工作方式>Operator 的工作方式</a></li></ul></li><li><a href=#resourceresourcetype-和-controller>Resource、ResourceType 和 Controller</a></li><li><a href=#使用-kubebuilder-开发-operator>使用 kubebuilder 开发 operator</a><ul><li><a href=#实现业务逻辑>实现业务逻辑</a></li><li><a href=#集成测试>集成测试</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=operator-模式>Operator 模式</h2><p>Kubernetes 是一个高度可扩展的"系统"，比如常见的自定义资源，控制器，准入控制及调度器进行扩展开发等。Operator 是一种包装、运行和管理 K8S 应用的一种方式。它涵盖了 CRD（CustomResourceDeftination） + AdmissionWebhook + Controller ，并以 Deployment 的形式部署到 K8S 中</p><ul><li><strong>CRD</strong> 用来定义声明式API（yaml），程序会通过该定义一直让最小调度单元（POD）趋向该状态</li><li><strong>AdmissionWebhook</strong> 用来拦截请求做 mutate（修改）提交的声明（yaml）和 validate（校验）声明式的字段</li><li><strong>Controller</strong> 主要的控制器，监视资源的 创建 / 更新 / 删除 事件，并触发 <code>Reconcile</code> 函数作为响应。整个调整过程被称作 Reconcile Loop（协调一致的循环），其实就是让 POD 趋向 CRD 定义所需的状态</li></ul><h3 id=operator-的工作方式>Operator 的工作方式</h3><p>Operator 通过扩展 Kubernetes 控制平面和 API 进行工作。Operator 将一个 endpoint（称为自定义资源 CR）添加到 Kubernetes API 中，该 endpoint 还包含一个监控和维护新类型资源的控制平面组件。整个操作原理如下图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102322563.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102322563.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102322563.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102322563.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102322563.png title=img></p><p>当 Operator 接收任何信息时，它将采取行动将 Kubernetes 集群或外部系统调整到所需的状态，作为其在自定义 controller 中的和解循环（reconciliation loop）的一部分</p><h2 id=resourceresourcetype-和-controller>Resource、ResourceType 和 Controller</h2><p>Kubernetes发展到今天，其本质已经显现：</p><ul><li>Kubernetes 就是一个 “数据库”（数据实际持久存储在etcd中）</li><li>其 API 就是 “sql语句”</li><li>API 设计采用基于 resource 的 Restful 风格，resource type 是 API 的端点（endpoint）</li><li>每一类 resource（即 Resource Type）是一张 “表”，Resource Type 的 spec 对应 “表结构” 信息（schema）</li><li>每张 “表” 里的一行记录就是一个 resource，即该表对应的 Resource Type 的一个实例（instance）</li><li>Kubernetes 这个 “数据库” 内置了很多 “表”，比如 Pod、Deployment、DaemonSet、ReplicaSet 等</li></ul><p>下面是一个Kubernetes API与resource关系的示意图：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102332099.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102332099.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102332099.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102332099.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102332099.png title=img></p><p>我们看到 resource type 有两类，一类的 namespace 相关的（namespace-scoped），另外一类则是 namespace 无关，即 cluster 范围（cluster-scoped）的</p><p>我们知道 Kubernetes 并非真的只是一个 “数据库”，它是服务编排和容器调度的平台标准，它的基本调度单元是Pod（也是一个resource type），即一组容器的集合。那么 Pod 又是如何被创建、更新和删除的呢？这就离不开控制器（controller）了。<strong>每一类 resource type 都有自己对应的控制器（controller）</strong>。以 pod 这个 resource type 为例，它的 controller 为 ReplicasSet 的实例。控制器的运行逻辑如下图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102334551.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102334551.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102334551.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102334551.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302102334551.png title=img></p><p>控制器一旦启动，将尝试获得 resource 的当前状态（current state），并与存储在 k8s 中的 resource 的期望状态（desired state，即 spec）做比对，如果不一致，controller 就会调用相应 API 进行调整，尽力使得 current state 与期望状态达成一致。这个达成一致的过程被称为<strong>协调（reconciliation）</strong></p><p>根据前面我们对 resource type 理解，定义 CRD 相当于建立新 “表”（resource type），一旦 CRD 建立，k8s 会为我们自动生成对应 CRD 的 API endpoint，我们就可以通过 yaml 或 API 来操作这个 “表”。我们可以向 “表” 中 “插入” 数据，即基于 CRD 创建 Custom Resource（CR），这就好比我们创建 Deployment 实例，向 Deployment “表” 中插入数据一样</p><p>和原生内置的 resource type 一样，光有存储对象状态的 CR 还不够，原生 resource type 有对应 controller 负责协调（reconciliation）实例的创建、伸缩与删除，CR 也需要这样的 “协调者”，即我们也需要定义一个 controller 来负责监听 CR 状态并管理 CR 创建、伸缩、删除以及保持期望状态（spec）与当前状态（current state）的一致。这个 controller 不再是面向原生 Resource type 的实例，而是<strong>面向 CRD 的实例 CR 的 controller</strong></p><p>有了自定义的操作对象类型（CRD），有了面向操作对象类型实例的 controller，我们将其打包为一个概念：“Operator模式”，operator 模式中的 controller 也被称为 operator，它是在集群中对 CR 进行维护操作的主体</p><h2 id=使用-kubebuilder-开发-operator>使用 kubebuilder 开发 operator</h2><p>Kubebuilder 是一个基于 CRD 来构建 Kubernetes API 的框架，可以使用 CRD 来构建 API、Controller 和 Admission Webhook。参考文档：<a href=https://book.kubebuilder.io/quick-start.html target=_blank rel="noopener noreffer">The Kubebuilder Book</a></p><p><strong>1. 安装 kubebuilder</strong></p><p>Github 地址：<a href=https://github.com/kubernetes-sigs/kubebuilder target=_blank rel="noopener noreffer">kubebuilder</a>，将 kubebuilder 拷贝到你的 PATH 环境变量中的某个路径下即可</p><p><strong>2. 创建项目</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubebuilder init --domain virtuallain.com
</span></span></code></pre></div><p><strong>3. 创建API</strong></p><p>这里我们就来建立自己的 CRD，即自定义的 resource type，也就是 API 的 endpoint</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubebuilder create api --group myapp --version v1 --kind Redis
</span></span></code></pre></div><p>此刻，整个工程的目录布局如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tree -F .
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Dockerfile
</span></span><span class=line><span class=cl>├── Makefile
</span></span><span class=line><span class=cl>├── PROJECT
</span></span><span class=line><span class=cl>├── README.md
</span></span><span class=line><span class=cl>├── api/
</span></span><span class=line><span class=cl>│   └── v1/
</span></span><span class=line><span class=cl>│       ├── groupversion_info.go
</span></span><span class=line><span class=cl>│       ├── redis_types.go
</span></span><span class=line><span class=cl>│       └── zz_generated.deepcopy.go
</span></span><span class=line><span class=cl>├── bin/
</span></span><span class=line><span class=cl>│   ├── controller-gen*
</span></span><span class=line><span class=cl>├── config/
</span></span><span class=line><span class=cl>│   ├── crd/
</span></span><span class=line><span class=cl>│   │   ├── bases/
</span></span><span class=line><span class=cl>│   │   │   └── myapp.virtuallain.com_redis.yaml
</span></span><span class=line><span class=cl>│   │   ├── kustomization.yaml
</span></span><span class=line><span class=cl>│   │   ├── kustomizeconfig.yaml
</span></span><span class=line><span class=cl>│   │   └── patches/
</span></span><span class=line><span class=cl>│   │       ├── cainjection_in_redis.yaml
</span></span><span class=line><span class=cl>│   │       └── webhook_in_redis.yaml
</span></span><span class=line><span class=cl>│   ├── default/
</span></span><span class=line><span class=cl>│   │   ├── kustomization.yaml
</span></span><span class=line><span class=cl>│   │   ├── manager_auth_proxy_patch.yaml
</span></span><span class=line><span class=cl>│   │   └── manager_config_patch.yaml
</span></span><span class=line><span class=cl>│   ├── manager/
</span></span><span class=line><span class=cl>│   │   ├── kustomization.yaml
</span></span><span class=line><span class=cl>│   │   └── manager.yaml
</span></span><span class=line><span class=cl>│   ├── prometheus/
</span></span><span class=line><span class=cl>│   │   ├── kustomization.yaml
</span></span><span class=line><span class=cl>│   │   └── monitor.yaml
</span></span><span class=line><span class=cl>│   ├── rbac/
</span></span><span class=line><span class=cl>│   │   ├── auth_proxy_client_clusterrole.yaml
</span></span><span class=line><span class=cl>│   │   ├── auth_proxy_role.yaml
</span></span><span class=line><span class=cl>│   │   ├── auth_proxy_role_binding.yaml
</span></span><span class=line><span class=cl>│   │   ├── auth_proxy_service.yaml
</span></span><span class=line><span class=cl>│   │   ├── kustomization.yaml
</span></span><span class=line><span class=cl>│   │   ├── leader_election_role.yaml
</span></span><span class=line><span class=cl>│   │   ├── leader_election_role_binding.yaml
</span></span><span class=line><span class=cl>│   │   ├── redis_editor_role.yaml
</span></span><span class=line><span class=cl>│   │   ├── redis_viewer_role.yaml
</span></span><span class=line><span class=cl>│   │   ├── role.yaml
</span></span><span class=line><span class=cl>│   │   ├── role_binding.yaml
</span></span><span class=line><span class=cl>│   │   └── service_account.yaml
</span></span><span class=line><span class=cl>│   └── samples/
</span></span><span class=line><span class=cl>│       └── myapp_v1_redis.yaml
</span></span><span class=line><span class=cl>├── controllers/
</span></span><span class=line><span class=cl>│   ├── redis_controller.go
</span></span><span class=line><span class=cl>│   └── suite_test.go
</span></span><span class=line><span class=cl>├── go.mod
</span></span><span class=line><span class=cl>├── go.sum
</span></span><span class=line><span class=cl>├── hack/
</span></span><span class=line><span class=cl>│   └── boilerplate.go.txt
</span></span><span class=line><span class=cl>├── main.go
</span></span></code></pre></div><p><strong>4. 为 CRD spec 添加字段</strong></p><p>CRD 与 api 中的 redis_types.go 文件是同步的，我们只需修改这个文件即可。在 RedisSpec 结构中增加 Port 和 Replicas 字段</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// RedisSpec defines the desired state of Redis
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>RedisSpec</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//+kubebuilder:validation:Minimum:=81
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//+kubebuilder:validation:Maximum=30000
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Port</span> <span class=kt>int</span> <span class=s>`json:&#34;port,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>//+kubebuilder:validation:Minimum:=1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//+kubebuilder:validation:Maximum=100
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Replicas</span> <span class=kt>int</span> <span class=s>`json:&#34;replicas,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>一旦定义完 CRD，我们就可以将其安装/卸载到 k8s 中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make install
</span></span><span class=line><span class=cl>make uninstall
</span></span></code></pre></div><p>查看</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get crd <span class=p>|</span> grep redis
</span></span></code></pre></div><p><strong>5. 实现 controller 的 Reconcile(协调) 逻辑</strong></p><p>kubebuilder 为我们搭好了 controller 的代码架子，我们只需要在 controllers/redis_controller.go 中实现RedisReconciler 的 Reconcile 方法即可。下面是 Reconcile 的一个简易流程图</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302110019743.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302110019743.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302110019743.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302110019743.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302110019743.png title=img></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RedisReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>redis</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>myappv1</span><span class=p>.</span><span class=nx>Redis</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span> <span class=nx>redis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{</span><span class=nx>RequeueAfter</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=o>*</span> <span class=mi>5</span><span class=p>},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;得到对象&#34;</span><span class=p>,</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Spec</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>6. 本地运行控制器</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make run
</span></span></code></pre></div><p>通过 kubectl 创建该 CR</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>myapp.virtuallain.com/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myredis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span></code></pre></div><p>观察 controller 的日志，可以看到当 CR 被创建后，controller 监听到相关事件</p><p><strong>7. 构建 controller image</strong></p><p>通过前文我们知道，这个 controller 其实就是运行在 k8s 中的一个 deployment 下的 pod，我们需要构建其 image 并通过 deployment 部署到 k8s 中。kubebuilder 创建的 operator 工程中包含了 Makefile，通过 <code>make docker-build</code> 即可构建 controller image，由于默认 GOPROXY 在国内无法访问，需要先修改 Dockerfile</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>GOPROXY</span><span class=o>=</span>https://goproxy.io<span class=err>
</span></span></span></code></pre></div><p>然后执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make docker build
</span></span></code></pre></div><p>构建成功后，执行 <code>make docker-push</code> 将 image 推送到镜像仓库中</p><p><strong>8. 部署 controller</strong></p><p>之前我们已经通过 <code>make install</code> 将 CRD 安装到k8s中了，接下来再把 controller 部署到 k8s 上，我们的 operator 就算部署完毕了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make deploy <span class=nv>IMG</span><span class=o>=</span>&lt;some-registry&gt;/&lt;project-name&gt;:tag
</span></span></code></pre></div><p>使用 <code>make undeploy</code> 可以完整卸载 operator 相关 resource</p><blockquote><p>因为一些特殊原因，一些镜像如 gcr.io/kubebuilder/kube-rbac-proxy 镜像可能拉取不下来，可以找到替代的镜像如 bitnami/kube-rbac-proxy 手动更改 tag</p></blockquote><h3 id=实现业务逻辑>实现业务逻辑</h3><ul><li>提交 CR 时自动创建 pod</li><li>动态伸缩副本</li><li>删除时清理关联 pod</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RedisReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span> <span class=p>=</span> <span class=nx>log</span><span class=p>.</span><span class=nf>FromContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>redis</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>myappv1</span><span class=p>.</span><span class=nx>Redis</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>,</span> <span class=nx>redis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 资源存在finalizers，删除时会增加DeletionTimestamp字段，只有当finalizers清空时才会真的删除
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>redis</span><span class=p>.</span><span class=nx>DeletionTimestamp</span><span class=p>.</span><span class=nf>IsZero</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>helper</span><span class=p>.</span><span class=nf>ClearRedis</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>redis</span><span class=p>)</span>	<span class=c1>// 清理资源
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>edited</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=nx>podNames</span> <span class=o>:=</span> <span class=nx>helper</span><span class=p>.</span><span class=nf>GetRedisPodNames</span><span class=p>(</span><span class=nx>redis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>diff</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Finalizers</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=nx>podNames</span><span class=p>)</span> <span class=c1>// 实际副本数量 - 期望副本数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>diff</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>                                 <span class=c1>// 收缩副本
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>helper</span><span class=p>.</span><span class=nf>RmIfSurplus</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>redis</span><span class=p>,</span> <span class=nx>podNames</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>edited</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建副本
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>podName</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podNames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>createPod</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>helper</span><span class=p>.</span><span class=nf>CreateRedis</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>redis</span><span class=p>,</span> <span class=nx>podName</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// pod创建成功且redis资源的finalizers列表不包含新创建的pod名称
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>createPod</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>controllerutil</span><span class=p>.</span><span class=nf>ContainsFinalizer</span><span class=p>(</span><span class=nx>redis</span><span class=p>,</span> <span class=nx>createPod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>redis</span><span class=p>.</span><span class=nx>Finalizers</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Finalizers</span><span class=p>,</span> <span class=nx>createPod</span><span class=p>)</span> <span class=c1>// 追加pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>edited</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>edited</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Client</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>redis</span><span class=p>)</span> <span class=c1>// 更新redis的Finalizers列表
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// GetRedisPodNames 根据副本数生成pod名称
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GetRedisPodNames</span><span class=p>(</span><span class=nx>redis</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Redis</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podNames</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Replicas</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>podNames</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s-%d&#34;</span><span class=p>,</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>podNames</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ExistPod 判断pod是否存在
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ExistPod</span><span class=p>(</span><span class=nx>client</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>podName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>redis</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Redis</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span><span class=nx>Namespace</span><span class=p>:</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>Name</span><span class=p>:</span> <span class=nx>podName</span><span class=p>},</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// CreateRedis 创建redis
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>CreateRedis</span><span class=p>(</span><span class=nx>client</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>redis</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Redis</span><span class=p>,</span> <span class=nx>podName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>schema</span> <span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nf>ExistPod</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>ctx</span><span class=p>,</span> <span class=nx>podName</span><span class=p>,</span> <span class=nx>redis</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span> <span class=p>=</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Namespace</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span> <span class=p>=</span> <span class=nx>podName</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span> <span class=p>=</span> <span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Container</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>            <span class=nx>podName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Image</span><span class=p>:</span>           <span class=s>&#34;redis:5-alpine&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>ImagePullPolicy</span><span class=p>:</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>PullIfNotPresent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Ports</span><span class=p>:</span> <span class=p>[]</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>ContainerPort</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>ContainerPort</span><span class=p>:</span> <span class=nb>int32</span><span class=p>(</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Port</span><span class=p>),</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 设置pod的ownReference为redis资源，删除redis资源时会删除关联的pod
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>controllerutil</span><span class=p>.</span><span class=nf>SetOwnerReference</span><span class=p>(</span><span class=nx>redis</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>schema</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>podName</span><span class=p>,</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Create</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// RmIfSurplus 收缩副本
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>RmIfSurplus</span><span class=p>(</span><span class=nx>client</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>redis</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Redis</span><span class=p>,</span> <span class=nx>podNames</span> <span class=p>[]</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rmPods</span> <span class=o>:=</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Finalizers</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>podNames</span><span class=p>):]</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>rmPod</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rmPods</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Name</span><span class=p>:</span>      <span class=nx>rmPod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Namespace</span><span class=p>:</span> <span class=nx>redis</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>redis</span><span class=p>.</span><span class=nx>Finalizers</span> <span class=p>=</span> <span class=nx>podNames</span> <span class=c1>// 更新finalizers
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ClearRedis 清理关联pod
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>ClearRedis</span><span class=p>(</span><span class=nx>client</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span><span class=p>,</span> <span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>redis</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Redis</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>	// pod设置了ownReference后，就可以不用手动清理pod了
</span></span></span><span class=line><span class=cl><span class=cm>	podList := redis.Finalizers
</span></span></span><span class=line><span class=cl><span class=cm>
</span></span></span><span class=line><span class=cl><span class=cm>	for _, podName := range podList {
</span></span></span><span class=line><span class=cl><span class=cm>		pod := &amp;corev1.Pod{
</span></span></span><span class=line><span class=cl><span class=cm>			ObjectMeta: metav1.ObjectMeta{
</span></span></span><span class=line><span class=cl><span class=cm>				Name:      podName,
</span></span></span><span class=line><span class=cl><span class=cm>				Namespace: redis.Namespace,
</span></span></span><span class=line><span class=cl><span class=cm>			},
</span></span></span><span class=line><span class=cl><span class=cm>		}
</span></span></span><span class=line><span class=cl><span class=cm>		if err := client.Delete(ctx, pod); err != nil {
</span></span></span><span class=line><span class=cl><span class=cm>			return err
</span></span></span><span class=line><span class=cl><span class=cm>		}
</span></span></span><span class=line><span class=cl><span class=cm>	}*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>redis</span><span class=p>.</span><span class=nx>Finalizers</span> <span class=p>=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{}</span>	<span class=c1>// 将finalizers设置为空，否则无法删除该CR
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=nx>client</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>redis</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>自动重建被手动删除的 pod</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 监听删除pod
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RedisReconciler</span><span class=p>)</span> <span class=nf>rmPodHandler</span><span class=p>(</span><span class=nx>event</span> <span class=nx>event</span><span class=p>.</span><span class=nx>DeleteEvent</span><span class=p>,</span> <span class=nx>limitingInterface</span> <span class=nx>workqueue</span><span class=p>.</span><span class=nx>RateLimitingInterface</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ref</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nf>GetOwnerReferences</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>ref</span><span class=p>.</span><span class=nx>Kind</span> <span class=o>==</span> <span class=s>&#34;Redis&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>ref</span><span class=p>.</span><span class=nx>APIVersion</span> <span class=o>==</span> <span class=s>&#34;myapp.virtuallain.com/v1&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 重建pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>limitingInterface</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>reconcile</span><span class=p>.</span><span class=nx>Request</span><span class=p>{</span> <span class=c1>// 重新入列 触发reconcile
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>NamespacedName</span><span class=p>:</span> <span class=nx>types</span><span class=p>.</span><span class=nx>NamespacedName</span><span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>Namespace</span><span class=p>:</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Object</span><span class=p>.</span><span class=nf>GetNamespace</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>					<span class=nx>Name</span><span class=p>:</span>      <span class=nx>ref</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// SetupWithManager sets up the controller with the Manager.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RedisReconciler</span><span class=p>)</span> <span class=nf>SetupWithManager</span><span class=p>(</span><span class=nx>mgr</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Manager</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nf>NewControllerManagedBy</span><span class=p>(</span><span class=nx>mgr</span><span class=p>).</span>
</span></span><span class=line><span class=cl>		<span class=nf>For</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>myappv1</span><span class=p>.</span><span class=nx>Redis</span><span class=p>{}).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Watches</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>source</span><span class=p>.</span><span class=nx>Kind</span><span class=p>{</span>	<span class=c1>// 增加watch
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>Type</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span> <span class=nx>handler</span><span class=p>.</span><span class=nx>Funcs</span><span class=p>{</span><span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>r</span><span class=p>.</span><span class=nx>rmPodHandler</span><span class=p>}).</span>
</span></span><span class=line><span class=cl>		<span class=nf>Complete</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>记录 Event 事件</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// controllers/redis_controller.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>RedisReconciler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>client</span><span class=p>.</span><span class=nx>Client</span>
</span></span><span class=line><span class=cl>        <span class=nx>Scheme</span>      <span class=o>*</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Scheme</span>
</span></span><span class=line><span class=cl>        <span class=nx>EventRecord</span> <span class=nx>record</span><span class=p>.</span><span class=nx>EventRecorder</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RedisReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>r</span><span class=p>.</span><span class=nx>EventRecord</span><span class=p>.</span><span class=nf>Event</span><span class=p>(</span><span class=nx>redis</span><span class=p>,</span> <span class=nx>corev1</span><span class=p>.</span><span class=nx>EventTypeNormal</span><span class=p>,</span> <span class=s>&#34;Upgrade&#34;</span><span class=p>,</span> <span class=s>&#34;副本收缩&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// main.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=p>=</span> <span class=p>(</span><span class=o>&amp;</span><span class=nx>controllers</span><span class=p>.</span><span class=nx>RedisReconciler</span><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Client</span><span class=p>:</span>        <span class=nx>mgr</span><span class=p>.</span><span class=nf>GetClient</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=nx>Scheme</span><span class=p>:</span>        <span class=nx>mgr</span><span class=p>.</span><span class=nf>GetScheme</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=nx>EventRecorder</span><span class=p>:</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>GetEventRecorderFor</span><span class=p>(</span><span class=s>&#34;Redis&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>}).</span><span class=nf>SetupWithManager</span><span class=p>(</span><span class=nx>mgr</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>setupLog</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;unable to create controller&#34;</span><span class=p>,</span> <span class=s>&#34;controller&#34;</span><span class=p>,</span> <span class=s>&#34;Redis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li>展示资源状态</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// api/v1/redis_types.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>RedisStatus</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Replicas</span> <span class=kt>int</span> <span class=s>`json:&#34;replicas&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 下面两个注释对应的是 kubectl get Redis 看到的状态  
</span></span></span><span class=line><span class=cl><span class=c1>//+kubebuilder:printcolumn:JSONPath=&#34;.status.replicas&#34;,name=replicas,type=integer
</span></span></span><span class=line><span class=cl><span class=c1>//+kubebuilder:printcolumn:JSONPath=&#34;.metadata.creationTimestamp&#34;,name=AGE,type=date
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>Redis</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// controllers/redis_controller.go
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>RedisReconciler</span><span class=p>)</span> <span class=nf>Reconcile</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>req</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>(</span><span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>redis</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Replicas</span> <span class=p>=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>redis</span><span class=p>.</span><span class=nx>Finalizers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Status</span><span class=p>().</span><span class=nf>Update</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>redis</span><span class=p>)</span> <span class=p>{</span>	<span class=c1>// 更新status
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nx>ctrl</span><span class=p>.</span><span class=nx>Result</span><span class=p>{},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=集成测试>集成测试</h3><p>（不推荐使用）参考文档：<a href=https://book.kubebuilder.io/cronjob-tutorial/writing-tests.html target=_blank rel="noopener noreffer">Writing tests</a>、<a href=https://book.kubebuilder.io/reference/envtest.html target=_blank rel="noopener noreffer">配置 EnvTest</a>、<a href=https://ke-chain.github.io/ginkgodoc/#%e5%85%a5%e9%97%a8-%e7%ac%ac%e4%b8%80%e4%b8%aa%e6%b5%8b%e8%af%95 target=_blank rel="noopener noreffer">Ginkgo</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-12&nbsp;<a class=git-hash href=https://github.com/xuliangTang/xuliangTang.github.io/commit/8e570bd38927a756ac09f1ab92625caf0c4cc21d target=_blank title="commit by Lain(1297441127@qq.com) 8e570bd38927a756ac09f1ab92625caf0c4cc21d: add: operator">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>8e570bd</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://xuliangtang.github.io/posts/operator/ data-title="使用 kubebuilder 开发 Operator"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://xuliangtang.github.io/posts/operator/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://xuliangtang.github.io/posts/operator/ data-title="使用 kubebuilder 开发 Operator"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://xuliangtang.github.io/posts/operator/ data-title="使用 kubebuilder 开发 Operator"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://xuliangtang.github.io/posts/operator/ data-title="使用 kubebuilder 开发 Operator"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/admission-webhook/ class=prev rel=prev title="Admission Webhook"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Admission Webhook</a>
<a href=/posts/prometheus/ class=next rel=next title="Prometheus 入门">Prometheus 入门<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.108.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xuliangTang</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"4ZKRIKL2L6",algoliaIndex:"dev_lain",algoliaSearchKey:"2da9b5e339083fde5fe030c2345f5499",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:80,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>