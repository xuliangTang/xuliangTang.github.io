<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Istio 快速入门 - Lain Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Istio 快速入门"><meta property="og:description" content="Istio 是一个开源的微服务管理、保护和监控框架，它有如下特性： 流量管理：利用配置，我们可以控制服务间的流量。设置断路器、超时或重试都可以通过简单的"><meta property="og:type" content="article"><meta property="og:url" content="http://xuliangtang.github.io/posts/istio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-02T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-04T21:13:37+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Istio 快速入门"><meta name=twitter:description content="Istio 是一个开源的微服务管理、保护和监控框架，它有如下特性： 流量管理：利用配置，我们可以控制服务间的流量。设置断路器、超时或重试都可以通过简单的"><meta name=application-name content="Lain Blog"><meta name=apple-mobile-web-app-title content="Lain Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://xuliangtang.github.io/posts/istio/><link rel=prev href=http://xuliangtang.github.io/posts/go-ca-cert/><link rel=next href=http://xuliangtang.github.io/posts/istio-grpc/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Istio 快速入门","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/xuliangtang.github.io\/posts\/istio\/"},"genre":"posts","wordcount":3722,"url":"http:\/\/xuliangtang.github.io\/posts\/istio\/","datePublished":"2023-02-02T00:00:00+00:00","dateModified":"2023-02-04T21:13:37+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xuliangTang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Istio 快速入门</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xuliangTang</a></span>&nbsp;<span class=post-category>included in <a href=/categories/istio/><i class="far fa-folder fa-fw" aria-hidden=true></i>Istio</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-02-02>2023-02-02</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3722 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#istio-组件>Istio 组件</a></li><li><a href=#安装>安装</a></li><li><a href=#sidecar-注入>Sidecar 注入</a><ul><li><a href=#手动注入>手动注入</a></li><li><a href=#自动注入>自动注入</a></li></ul></li><li><a href=#示例配置>示例配置</a></li><li><a href=#gateway>Gateway</a></li><li><a href=#virtual-service>Virtual Service</a></li><li><a href=#destination-rule>Destination Rule</a><ul><li><a href=#负载均衡器设置>负载均衡器设置</a></li><li><a href=#connectionpool-限流设置>connectionPool 限流设置</a></li><li><a href=#outlierdetection-熔断设置>outlierDetection 熔断设置</a></li></ul></li><li><a href=#故障注入>故障注入</a></li><li><a href=#配置网关-jwt-验证>配置网关 JWT 验证</a><ul><li><a href=#jwk-生成>JWK 生成</a></li><li><a href=#定义-requestauthentication>定义 RequestAuthentication</a></li><li><a href=#跨域配置>跨域配置</a></li><li><a href=#定义-envoy-filter>定义 Envoy Filter</a></li></ul></li><li><a href=#authorization-policy>Authorization Policy</a></li><li><a href=#开启自动-mtls>开启自动 mTLS</a></li></ul></nav></div></div><div class=content id=content><p><a href=https://istio.io/latest/zh/docs/ target=_blank rel="noopener noreffer">Istio</a> 是一个开源的微服务管理、保护和监控框架，它有如下特性：</p><ol><li>流量管理：利用配置，我们可以控制服务间的流量。设置断路器、超时或重试都可以通过简单的配置改变来完成。</li><li>可观察性：Istio 通过跟踪、监控和记录让我们更好地了解服务，让我们能够快速发现和修复问题。</li><li>安全性：Istio 可以在代理层面上管理认证、授权和通信的加密。我们可以通过快速的配置变更在各个服务中执行策略。</li></ol><h2 id=istio-组件>Istio 组件</h2><p>Istio 服务网格有两个部分：数据平面和控制平面</p><ul><li>数据平面由一组智能代理 (Envoy) 组成，被部署为 sidecar，控制服务之间的通信</li><li>控制平面管理并配置代理来进行流量路由</li></ul><p>下图展示了组成每个平面的不同组件：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022108721.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022108721.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022108721.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022108721.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022108721.png title=Istio架构图></p><h2 id=安装>安装</h2><p>从 <a href=https://github.com/istio/istio/releases target=_blank rel="noopener noreffer">Github</a> 上下载 Istio， (测试环境) 执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>istioctl manifest apply --set <span class=nv>profile</span><span class=o>=</span>demo
</span></span></code></pre></div><p>可以查看其中的配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>istioctl profile dump demo
</span></span></code></pre></div><h2 id=sidecar-注入>Sidecar 注入</h2><p>网格中的 Pod 必须运行一个 Istio Sidecar 代理，两种方法：使用 istioctl 手动注入或启用 Pod 所属命名空间的 Istio sidecar 注入器自动注入，启用自动注入后，自动注入器会使用准入控制器在创建 Pod 时自动注入代理配置</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022122730.jpeg data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022122730.jpeg, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022122730.jpeg 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022122730.jpeg 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302022122730.jpeg title="Sidecar 模式示意图"></p><h3 id=手动注入>手动注入</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl> istioctl kube-inject -f api.yaml <span class=p>|</span> kubectl apply -f –
</span></span></code></pre></div><h3 id=自动注入>自动注入</h3><p>将 myistio 命名空间标记为 <code>istio-injection=enabled</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl label namespace myistio istio-injection<span class=o>=</span>enabled
</span></span></code></pre></div><h2 id=示例配置>示例配置</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>p-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myistio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w> </span><span class=c># use Istio default gateway implementation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>servers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>p.virtuallain.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodvs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myistio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>prodsvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>reviewsvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>p.virtuallain.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>p-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mesh</span><span class=w> </span><span class=c># 用于内部服务互访</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/p&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rewrite</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>uri</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/prods&#34;</span><span class=w> </span><span class=c># 路径重写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>prodsvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1svc</span><span class=w> </span><span class=c># 服务端点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fault</span><span class=p>:</span><span class=w> </span><span class=c># 延迟故障注入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>delay</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fixedDelay</span><span class=p>:</span><span class=w> </span><span class=l>1ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>percentage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>1s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>reviewsvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#    fault:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      abort:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#        httpStatus: 500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#        percentage:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#          value: 100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DestinationRule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prod-rule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myistio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>prodsvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>trafficPolicy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w> </span><span class=c># 负载均衡</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#      simple: ROUND_ROBIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>consistentHash</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>httpHeaderName</span><span class=p>:</span><span class=w> </span><span class=l>myname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>connectionPool</span><span class=p>:</span><span class=w> </span><span class=c># 限流</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tcp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>maxConnections</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>http1MaxPendingRequests</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>maxRequestsPerConnection</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>outlierDetection</span><span class=p>:</span><span class=w> </span><span class=c># 熔断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>consecutive5xxErrors</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxEjectionPercent</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>baseEjectionTime</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>subsets</span><span class=p>:</span><span class=w> </span><span class=c># 定义服务端点集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>v1svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># version: v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prod</span><span class=w>
</span></span></span></code></pre></div><h2 id=gateway>Gateway</h2><p>网格服务的负载均衡器，负责网格边缘的服务暴露。可以使用 Gateway 资源来配置网关，网关资源描述了负责均衡器的暴露端口、协议、SNI (服务器名称指示) 配置等。网关资源在背后控制着 Envoy 代理在网络接口上的监听方式以及它出示的证书，其中</p><ul><li>Ingress-gateway: 用于管理网格边缘入站的流量，通过入口网关将网格内部的服务暴露到外部提供访问，配合 VirtualService</li><li>Egress gateway: 控制网格内服务访问外部服务，配合 DestinationRule</li></ul><h2 id=virtual-service>Virtual Service</h2><p>虚拟服务可以理解为 k8s service 的一种增强，我们可以使用 VirtualService 资源在 Istio 服务网格中定义流量路由规则，并在客户端试图连接到服务时应用这些规则</p><ol><li>配置如何在服务网格内将请求路由到服务</li><li>和网关整合并配置流量规则来控制出入流量</li></ol><h2 id=destination-rule>Destination Rule</h2><p>目标规则用于配置将流量转发到实际工作负载时应用的策略，如流量拆分、灰度发布、负载均衡等</p><p>subset (子集) 是服务端点的集合，可以用于 A/B 测试或者分版本路由等场景</p><h3 id=负载均衡器设置>负载均衡器设置</h3><p>基本配置参数：</p><ol><li><p>简单类型 (<code>simple</code>)：</p><ul><li><code>ROUND_ROBIN</code>: 轮询 (默认)</li><li><code>LEAST_CONN</code>: 最少连接，选择请求较少的主机</li><li><code>RANDOM</code>: 随机选择</li></ul></li><li><p>一致性哈希 (<code>consistentHash</code>): 目的是让同一用户的请求一直转发到后端同一实例</p><ul><li><code>httpHeaderName</code>: 基于 header 头</li><li><code>httpCookie</code>: 基于 cookie</li><li><code>useSourceIp</code>: 基于 ip</li><li><code>minimumRingSize</code>: 环形哈希算法，适用于较多节点、频繁新增和删除节点的场景，填数字虚拟节点数量</li></ul></li></ol><h3 id=connectionpool-限流设置>connectionPool 限流设置</h3><p>ConnectionPool 可以对上游服务的并发连接数和请求数进行限制。适用于 HTTP 和 TCP 服务</p><p>基本配置参数：</p><p><strong>TCP</strong></p><ul><li><code>maxConnections</code>: 最大 HTTP1 / TCP 连接数 (默认值2 ^ 32-1)</li><li><code>connectTimeout</code>: 连接超时。格式为 1h / 1m / 1s / 1ms (默认值为10秒)</li><li><code>tcpKeepalive</code>: keepalive 设置<ul><li>probes: 确认连接dead之前继续发送探测数据，发送几次 (默认9)</li><li>time: 发送probe之前连接的空闲时间 (默认2小时)</li><li>interval: 两次probe发送的间隔 (默认75秒)</li></ul></li></ul><p><strong>HTTP</strong></p><ul><li><code>http1MaxPendingRequests</code>: 等待时将排队的最大请求数 就绪的连接池连接 (默认为1024)</li><li><code>http2MaxRequests</code>: 对目标的活动请求的最大数量 (默认为1024)</li><li><code>maxRequestsPerConnection</code>: 每个连接的最大请求数量。如果将这一参数设置为 1 则会禁止 keepalive 特性</li><li><code>idleTimeout</code>: 上游连接池连接的空闲超时，当达到空闲超时时，连接将被关闭</li><li><code>maxRetries</code>: 最大重试次数 (默认为3)</li></ul><h3 id=outlierdetection-熔断设置>outlierDetection 熔断设置</h3><p>跟踪每个状态的断路器实现上游服务中的单个主机。适用于 HTTP 和 TCP 服务</p><p>基本配置参数：</p><ul><li><code>consecutive5xxErrors</code>: 连续 5xx 错误异常数</li><li><code>interval</code>: 错误异常的扫描间隔 (默认10秒) ，期间连续发生指定数量个异常则熔断</li><li><code>baseEjectionTime</code>: 驱逐时间 (默认30秒)</li><li><code>maxEjectionPercent</code>: 最大驱逐百分比 (默认10%)</li><li><code>minHealthPercent</code>: 至少最低健康百分比的主机，就将启用异常检测。当负载平衡池中的正常主机百分比降至此阈值以下时，异常检测将被禁用默认值为0％，因为它通常不适用于每项服务只有少量 pod 的 k8s 环境</li></ul><h2 id=故障注入>故障注入</h2><p>为了帮助我们提高服务的弹性，我们可以使用故障注入功能。我们可以在 HTTP 流量上应用故障注入策略，在转发目的地的请求时指定一个或多个故障注入</p><p>有两种类型的故障注入。我们可以在转发前延迟（delay）请求，模拟缓慢的网络或过载的服务，我们可以中止（abort） HTTP 请求，并返回一个特定的 HTTP 错误代码给调用者。通过中止，我们可以模拟一个有故障的上游服务</p><h2 id=配置网关-jwt-验证>配置网关 JWT 验证</h2><p>Istio 支持使用 JWT 对终端用户进行身份验证，支持多种 JWT 签名算法，常见的 JWT 签名算法：</p><ul><li>HS256: 对称加密，加密和解密用的是同一个秘钥</li><li>RS256: RSA 私钥签名，公钥进行验证</li><li>ES256: 类似 RS256</li></ul><p>Istio 要求提供 JWKS 格式的信息，用于 JWT 签名验证，是一个 JSON 格式的文件，如：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nt>&#34;keys&#34;</span><span class=p>:[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;e&#34;</span><span class=p>:</span><span class=s2>&#34;AQAB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;kid&#34;</span><span class=p>:</span><span class=s2>&#34;DHFbpoIUqrY8t2zpA2qXfCmr5VO5ZEr4RzHU_-envvQ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;kty&#34;</span><span class=p>:</span><span class=s2>&#34;RSA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=nt>&#34;n&#34;</span><span class=p>:</span><span class=s2>&#34;xAE7eB6qugXyCAG3yhh7pkD...&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>JWKS 描述一组 JWK 密钥。它能同时描述多个可用的公钥，应用场景之一是密钥的 Rotate。而 JWK，全称是 Json Web Key，它描述了一个加密密钥（公钥或私钥）的各项属性，包括密钥的值。Istio 使用 JWK 描述验证 JWT 签名所需要的信息。在使用 RSA 签名算法时，JWK 描述的应该是用于验证的 RSA 公钥。一个 RSA 公钥的 JWK 描述如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;alg&#34;</span><span class=p>:</span> <span class=s2>&#34;RS256&#34;</span><span class=p>,</span>  <span class=err>#</span> <span class=err>算法「可选参数」</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kty&#34;</span><span class=p>:</span> <span class=s2>&#34;RSA&#34;</span><span class=p>,</span>    <span class=err>#</span> <span class=err>密钥类型</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;use&#34;</span><span class=p>:</span> <span class=s2>&#34;sig&#34;</span><span class=p>,</span>    <span class=err>#</span> <span class=err>被用于签名「可选参数」</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kid&#34;</span><span class=p>:</span> <span class=s2>&#34;NjVBRjY5MDlCMUIwNzU4RTA2QzZFMDQ4QzQ2MDAyQjVDNjk1RTM2Qg&#34;</span><span class=p>,</span>  <span class=err>#</span> <span class=err>key</span> <span class=err>的唯一</span> <span class=err>id</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;n&#34;</span><span class=p>:</span> <span class=s2>&#34;yeNlzlub94YgerT030codqEztjfU_S6X4DbDA_iVKkjAWtYfPHDzz_sPCT1Axz6isZdf3lHpq_gYX4Sz-cbe4rjmigxUxr-FgKHQy3HeCdK6hNq9ASQvMK9LBOpXDNn7mei6RZWom4wo3CMvvsY1w8tjtfLb-yQwJPltHxShZq5-ihC9irpLI9xEBTgG12q5lGIFPhTl_7inA1PFK97LuSLnTJzW0bj096v_TMDg7pOWm_zHtF53qbVsI0e3v5nmdKXdFf9BjIARRfVrbxVxiZHjU6zL6jY5QJdh1QCmENoejj_ytspMmGW7yMRxzUqgxcAqOBpVm0b-_mW3HoBdjQ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;e&#34;</span><span class=p>:</span> <span class=s2>&#34;AQAB&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>RSA 是基于大数分解的加密/签名算法，上述参数中，<code>e</code> 是公钥的模数(modulus)，<code>n</code> 是公钥的指数(exponent)，两个参数都是 base64 字符串。</p><p>JWK 中 RSA 公钥的具体定义参见 <a href=https://tools.ietf.org/html/rfc7518#page-30 target=_blank rel="noopener noreffer">RSA Keys - JSON Web Algorithms (JWA)</a></p><h3 id=jwk-生成>JWK 生成</h3><p>RS256 使用 RSA 算法进行签名，可通过如下命令生成 RSA 密钥：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 生成 2048 位（不是 256 位）的 RSA 密钥</span>
</span></span><span class=line><span class=cl>openssl genrsa -out rsa-private-key.pem <span class=m>2048</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 通过密钥生成公钥</span>
</span></span><span class=line><span class=cl>openssl rsa -in rsa-private-key.pem -pubout -out rsa-public-key.pem
</span></span></code></pre></div><p>接下来使用 <a href=https://github.com/lestrrat-go/jwx target=_blank rel="noopener noreffer">jwx</a> 库生成 JWK</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>pubKey</span><span class=p>()</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=s>&#34;./rsa-public-key.pem&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>b</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>jwk</span><span class=p>.</span><span class=nf>ParseKey</span><span class=p>(</span><span class=nf>pubKey</span><span class=p>(),</span> <span class=nx>jwk</span><span class=p>.</span><span class=nf>WithPEM</span><span class=p>(</span><span class=kc>true</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>rsaKey</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>key</span><span class=p>.(</span><span class=nx>jwk</span><span class=p>.</span><span class=nx>RSAPublicKey</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>rsaKey</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalln</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>可以在 <a href=https://jwt.io/ target=_blank rel="noopener noreffer">jwt.io</a> 中测试密钥的可用性和生成 Token</p><h3 id=定义-requestauthentication>定义 RequestAuthentication</h3><p>启用 Istio 的身份验证</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RequestAuthentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jwt-test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w> </span><span class=c># 在带有这些 labels 的 ingressgateway/sidecar 上生效</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jwtRules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># issuer 即签发者，需要和 JWT payload 中的 iss 属性完全一致</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>issuer</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;user@virtuallain.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>jwks</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        {
</span></span></span><span class=line><span class=cl><span class=sd>            &#34;keys&#34;: [
</span></span></span><span class=line><span class=cl><span class=sd>                {
</span></span></span><span class=line><span class=cl><span class=sd>                    &#34;e&#34;:&#34;AQAB&#34;,
</span></span></span><span class=line><span class=cl><span class=sd>                    &#34;kty&#34;:&#34;RSA&#34;,
</span></span></span><span class=line><span class=cl><span class=sd>                    &#34;n&#34;:&#34;tFLKvS2EMOu3vgPnUPkdn5xVau9-dWf0z30_EdbpadQLiVsHH0FqWl-8CgtNtxnUjrI6WN__BMX8jLzvEqKrdZnbTMS0EaTh8lfGbFxNd0qziVHlYZTH-gtPNI4r815y9OuY7DEuR8fG-B_iHuCslN3BcJ4TDF_tzKCF0USGzzEiiRPR4SBtZgz0tmteQgRTv1NfciOwCtedEtXRKnGI5W1GV5u2dmF6UCiWJdgsqHMsVzTXJz_wliVvKhczwhrFZfqvdBoOe_aays89AjcO4x7eUntZVvOlkowaD-UeUeT6ZL8q4oTWGpswA4YNJ_daZmtAU5ho11EW6F3q1YHjVQ&#34;
</span></span></span><span class=line><span class=cl><span class=sd>                 }
</span></span></span><span class=line><span class=cl><span class=sd>            ]
</span></span></span><span class=line><span class=cl><span class=sd>        }</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># jwks 或 jwksUri 二选其一 (测试中发现 jwksUri 会出现各种问题)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># jwksUri: &#34;http://nginx.test.local/istio/jwks.json&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>forwardOriginalToken</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>  </span><span class=c># 转发 Authorization 请求头</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>outputPayloadToHeader</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Userinfo&#34;</span><span class=w> </span><span class=c># 转发 jwt payload 数据 (base64编码)</span><span class=w>
</span></span></span></code></pre></div><p>可以看到 jwtRules 是一个列表，因此可以为每个 issuers 配置不同的 jwtRule.</p><p>对同一个 issuers（jwt 签发者），可以通过 jwks 设置多个公钥，以实现JWT签名密钥的轮转。 JWT 的验证规则是：</p><ol><li>JWT 的 payload 中有 issuer 属性，首先通过 issuer 匹配到对应的 istio 中配置的 jwks。</li><li>JWT 的 header 中有 kid 属性，第二步在 jwks 的公钥列表中，中找到 kid 相同的公钥。</li><li>使用找到的公钥进行 JWT 签名验证。</li></ol><blockquote><p>配置中的 <code>spec.selector</code> 可以省略，这样会直接在整个 namespace 中生效，而如果是在 <code>istio-system</code> 名字空间，该配置将在全集群的所有 sidecar/ingressgateway 上生效</p></blockquote><p>加了转发后，流程图如下：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302040023467.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302040023467.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302040023467.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302040023467.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302040023467.png title=image-20230204002255161></p><h3 id=跨域配置>跨域配置</h3><p>给 vs 增加 corsPolicy 节点</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>VirtualService</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodvs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myistio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>prodsvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>p.virtuallain.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>gateways</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>pp-gateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>mesh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>uri</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>prefix</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>prodsvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>subset</span><span class=p>:</span><span class=w> </span><span class=l>v1svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>corsPolicy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>allowOrigins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>exact</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>allowMethods</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>GET</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>POST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>PATCH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>PUT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>DELETE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>OPTIONS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>allowCredentials</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>allowHeaders</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>authorization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxAge</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;24h&#34;</span><span class=w>
</span></span></span></code></pre></div><h3 id=定义-envoy-filter>定义 Envoy Filter</h3><p>RequestsAuthentication 不支持自定义响应头信息，这导致对于前后端分离的 Web API 而言， 一旦 JWT 失效，Istio 会直接将 401 返回给前端 Web 页面。 因为响应头中不包含 <code>Access-Crontrol-Allow-Origin</code>，响应将被浏览器拦截，需要通过 EnvoyFilter 自定义响应头，添加跨域信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.istio.io/v1alpha3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>EnvoyFilter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>reorder-cors-before-jwt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>workloadSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configPatches</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>applyTo</span><span class=p>:</span><span class=w> </span><span class=l>HTTP_FILTER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>GATEWAY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>listener</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>filterChain</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;envoy.filters.network.http_connection_manager&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>subFilter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;envoy.filters.http.cors&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>patch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operation</span><span class=p>:</span><span class=w> </span><span class=l>REMOVE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>applyTo</span><span class=p>:</span><span class=w> </span><span class=l>HTTP_FILTER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>GATEWAY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>listener</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>filterChain</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>filter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;envoy.filters.network.http_connection_manager&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>subFilter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;envoy.filters.http.jwt_authn&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>patch</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operation</span><span class=p>:</span><span class=w> </span><span class=l>INSERT_BEFORE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;envoy.filters.http.cors&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>typed_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;@type&#34;: </span><span class=s2>&#34;type.googleapis.com/envoy.extensions.filters.http.cors.v3.Cors&#34;</span><span class=w>
</span></span></span></code></pre></div><h2 id=authorization-policy>Authorization Policy</h2><p>Istio 允许我们使用 AuthorizationPolicy (授权策略) 资源在网格、命名空间和工作负载层面定义访问控制。 支持 DENY、ALLOW、AUDIT 和 CUSTOM 操作。</p><p>rule 规则包括 <code>from</code> (来源)、<code>to</code> (操作) 和 <code>when</code> (条件)</p><p><strong>来源</strong></p><ul><li><code>principals</code> (如 my-service-account): 具有 my-service-account 的工作负载，需要开启 mTLS (双向认证)</li><li><code>requestPrincipals</code> (如 my-issuer/hello): 具有有效 JWT 和请求主体 my-issuer/hello 的工作负载</li><li><code>namespaces</code> (如 default): 任何来自 default 命名空间的工作负载</li><li><code>ipBlocks</code> (如 [&ldquo;1.2.3.4&rdquo;, &ldquo;9.8.7.6/15&rdquo;]): 任何 IP 或者 CIDR 块的 IP 的工作负载</li><li><code>remoteIpBlocks</code>: 针对 remote.ip (如 X-Forwarded-For)</li></ul><p>每个选项都有一个 notXxx 作为反义词</p><p><strong>操作</strong></p><ul><li><code>hosts</code> 和 <code>notHosts</code></li><li><code>ports</code> 和 <code>notPorts</code></li><li><code>methods</code> 和 <code>notMethods</code></li><li><code>path</code> 和 <code>notPath</code></li></ul><p>所有这些操作都适用于请求属性。例如，要在一个特定的请求路径上进行匹配，我们可以使用路径 (如 ["/api/*", &ldquo;/admin&rdquo;]) 或特定的端口 ([&ldquo;8080&rdquo;])</p><p><strong>条件</strong></p><p>为了指定条件，我们必须提供一个 key 字段，key 字段是一个 Istio 属性的名称。例如 <code>request.headers</code>、<code>source.ip</code>、<code>request.auth.claims[xx]</code> 等。条件的第二部分是 values 或 notValues 的字符串列表</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>AuthorizationPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prod-authpolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>istio-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>ALLOW</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>istio</span><span class=p>:</span><span class=w> </span><span class=l>ingressgateway</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>source</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>requestPrincipals</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span>- <span class=nt>operation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>methods</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;GET&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>paths</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/prods/*&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>to</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>operation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>methods</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;GET&#34;</span><span class=p>,</span><span class=s2>&#34;POST&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>paths</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/admin&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>when</span><span class=p>:</span><span class=w> </span><span class=c># payload 中必须包含值为 admin 或 superadmin 的 role 字段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>request.auth.claims[role]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;admin&#34;</span><span class=p>,</span><span class=s2>&#34;superadmin&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></div><h2 id=开启自动-mtls>开启自动 mTLS</h2><p>服务中的工作负载之间的通信是通过 Envoy 代理进行的。当一个工作负载使用 mTLS 向另一个工作负载发送请求时，Istio 会将流量重新路由到 sidecar 代理（Envoy）</p><p>然后，sidecar Envoy 开始与服务器端的 Envoy 进行 mTLS 握手。在握手过程中，调用者会进行安全命名检查，以验证服务器证书中的服务账户是否被授权运行目标服务。一旦 mTLS 连接建立，Istio 就会将请求从客户端的 Envoy 代理转发到服务器端的 Envoy 代理。在服务器端的授权后，sidecar 将流量转发到工作负载</p><p>可以创建 PeerAuthentication 资源，首先在每个命名空间中分别执行严格模式。然后，我们可以在根命名空间创建一个策略，在整个服务网格中执行该策略。或者指定 selector，仅应用于网格中的特定工作负载。它有三大模式：</p><ul><li><code>PERMISSIVE</code>：同时接受未加密连接和双向加密连接</li><li><code>STRICT</code>：只接受加密连接</li><li><code>DISABLE</code>：关闭双向加密连接</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>security.istio.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PeerAuthentication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>testmtls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myistio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>reviews</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mtls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=l>STRICT</span><span class=w>
</span></span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-04&nbsp;<a class=git-hash href=https://github.com/xuliangTang/xuliangTang.github.io/commit/e2a0cf48ef8c615c39375acc8ba3eddf8660f6ee target=_blank title="commit by Lain(1297441127@qq.com) e2a0cf48ef8c615c39375acc8ba3eddf8660f6ee: update: istio">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>e2a0cf4</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://xuliangtang.github.io/posts/istio/ data-title="Istio 快速入门"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://xuliangtang.github.io/posts/istio/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://xuliangtang.github.io/posts/istio/ data-title="Istio 快速入门"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://xuliangtang.github.io/posts/istio/ data-title="Istio 快速入门"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://xuliangtang.github.io/posts/istio/ data-title="Istio 快速入门"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/go-ca-cert/ class=prev rel=prev title="使用 Go 生成自签 CA 证书"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>使用 Go 生成自签 CA 证书</a>
<a href=/posts/istio-grpc/ class=next rel=next title="Istio 部署 gRPC 服务并配置网关证书">Istio 部署 gRPC 服务并配置网关证书<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.108.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xuliangTang</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{},search:{algoliaAppID:"4ZKRIKL2L6",algoliaIndex:"dev_lain",algoliaSearchKey:"2da9b5e339083fde5fe030c2345f5499",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:80,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>