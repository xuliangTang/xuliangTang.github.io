<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Prometheus 入门 - Lain Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Prometheus 入门"><meta property="og:description" content="为了提升服务的稳定性，我们需要不断的收集数据，分析数据，监控数据，进而优化能优化的点，Prometheus 在这方面就为我们提供了很好的监控方"><meta property="og:type" content="article"><meta property="og:url" content="http://xuliangtang.github.io/posts/prometheus/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-19T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-23T22:41:38+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Prometheus 入门"><meta name=twitter:description content="为了提升服务的稳定性，我们需要不断的收集数据，分析数据，监控数据，进而优化能优化的点，Prometheus 在这方面就为我们提供了很好的监控方"><meta name=application-name content="Lain Blog"><meta name=apple-mobile-web-app-title content="Lain Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://xuliangtang.github.io/posts/prometheus/><link rel=prev href=http://xuliangtang.github.io/posts/operator/><link rel=next href=http://xuliangtang.github.io/posts/fluent-bit/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Prometheus 入门","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/xuliangtang.github.io\/posts\/prometheus\/"},"genre":"posts","wordcount":8502,"url":"http:\/\/xuliangtang.github.io\/posts\/prometheus\/","datePublished":"2023-02-19T00:00:00+00:00","dateModified":"2023-02-23T22:41:38+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xuliangTang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Prometheus 入门</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xuliangTang</a></span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-02-19>2023-02-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;8502 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;17 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#整体架构>整体架构</a></li><li><a href=#部署>部署</a><ul><li><a href=#kube-state-metrics>kube-state-metrics</a></li><li><a href=#node_exporter>node_exporter</a></li><li><a href=#prometheus>prometheus</a></li></ul></li><li><a href=#服务自动发现>服务自动发现</a><ul><li><a href=#pod-监控>Pod 监控</a></li></ul></li><li><a href=#基本查询>基本查询</a><ul><li><a href=#即时向量>即时向量</a></li><li><a href=#区间向量>区间向量</a></li><li><a href=#聚合操作符>聚合操作符</a></li><li><a href=#函数>函数</a></li></ul></li><li><a href=#自定义指标>自定义指标</a><ul><li><a href=#自动发现>自动发现</a></li></ul></li><li><a href=#prometheus-adapter>Prometheus Adapter</a><ul><li><a href=#部署-1>部署</a></li><li><a href=#创建自定义指标>创建自定义指标</a></li></ul></li><li><a href=#自定义-metrics-hpa>自定义 metrics HPA</a><ul><li><a href=#缩容>缩容</a></li></ul></li><li><a href=#alertmanager>AlertManager</a><ul><li><a href=#自定义-webhook>自定义 webhook</a></li><li><a href=#配置文件>配置文件</a></li><li><a href=#部署-2>部署</a></li><li><a href=#在-prometheus-中创建报警规则>在 prometheus 中创建报警规则</a></li><li><a href=#模板>模板</a></li><li><a href=#子路由>子路由</a></li><li><a href=#静默>静默</a></li><li><a href=#告警抑制>告警抑制</a></li><li><a href=#amtool>amtool</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>为了提升服务的稳定性，我们需要不断的收集数据，分析数据，监控数据，进而优化能优化的点，Prometheus 在这方面就为我们提供了很好的监控方案。Prometheus 是一个开源的监控和报警系统，它将我们关心的指标值通过 PULL 的方式获取并存储为时间序列数据。如果单从它的收集功能来讲，我们也可以通过 mysql、redis 等方式实现。然而，这些数据是在每时每刻产生的，其庞大的规模需要我们好好的考虑其存储方式。另外，这些监控数据大多数时候是跟统计相关的，比如数据与时间的分布情况等</p><p>由于 Prometheus 的关注重点在于指标值以及时间点这两个因素，所以外部程序对它的接入成本非常的低。这种易用性可以让我们对数据进行多维度、多角度的观察和分析，使得监控的效果更加具体化，例如内存消耗、网络利用率、请求连接数等</p><p>除此之外，Prometheus 还具备了操作简单、可拓展的数据收集和强大的查询语言等特性，这些特性能帮助我们在问题出现的时候，快速告警并定位错误。所以现在很多微服务基础设施都会选择接入 Prometheus，像 k8s、云原生等</p><h2 id=整体架构>整体架构</h2><p>Prometheus 为了保证它的拓展性、可靠性，在除了提供核心的 server 外还提供了很多生态组件，为了不增加理解的复杂度，我们先从上帝视角，看看它的核心 Prometheus server</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172219125.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172219125.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172219125.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172219125.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172219125.png title=image-20230217221855601></p><p>可以看到，Prometheus server 的处理链路很清晰，其实就是数据收集-数据存储-数据查询。当然，一个完善的系统肯定会衍生出许多组件来支撑它的特性。所以我们会看到，在 Prometheus 架构里还存在着其他的组件，例如：</p><ul><li>Pushgateway：为监控节点提供 Push 功能，再由 Prometheus server 到 Pushgateway 集中 Pull 数据</li><li>Targets Discover：根据服务发现获取监控节点的地址</li><li>PromQL：针对指标数据查询的语言，类似 SQL</li><li>Alertmanager：根据配置规则以及指标分析，提供告警服务</li></ul><p>最后，Prometheus 的整体架构如下</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172220283.jpeg data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172220283.jpeg, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172220283.jpeg 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172220283.jpeg 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202302172220283.jpeg title=img></p><h2 id=部署>部署</h2><h3 id=kube-state-metrics>kube-state-metrics</h3><p><a href=https://github.com/kubernetes/kube-state-metrics target=_blank rel="noopener noreffer">kube-state-metrics</a> 是官方提供的 k8s 内部各个组件的状态指标，通过监听 API Server 生成有关资源对象（如 Deployment、Node、Pod）的状态指标（如副本数有几个、pod 状态、重启了几次）</p><p>参考配置：<a href=https://github.com/kubernetes/kube-state-metrics/tree/main/examples/standard target=_blank rel="noopener noreffer">kube-state-metrics/examples/standard</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/component</span><span class=p>:</span><span class=w> </span><span class=l>exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/version</span><span class=p>:</span><span class=w> </span><span class=m>2.8.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort	# 这里改成了NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=l>http-metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>32280</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>telemetry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=l>telemetry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app.kubernetes.io/name</span><span class=p>:</span><span class=w> </span><span class=l>kube-state-metrics</span><span class=w>
</span></span></span></code></pre></div><h3 id=node_exporter>node_exporter</h3><p><a href=https://github.com/prometheus/node_exporter target=_blank rel="noopener noreffer">node-exporter</a> 用来监控节点 CPU、内存、磁盘、I/O 等信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostPID</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostIPC</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hostNetwork</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-exporter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>bitnami/node-exporter:1.2.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>100Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>path.procfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/host/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>path.sysfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/host/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- --<span class=l>collector.filesystem.ignored-mount-points</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s1>&#39;&#34;^/(sys|proc|dev|host|etc)($|/)&#34;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/host/sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node-role.kubernetes.io/master&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>proc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/proc</span><span class=w> </span><span class=c># CPU信息、内存信息、内核信息等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/dev	# 存放与设备（包括外设）有关的文件，如打印机、USB、串口/并口等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/sys</span><span class=w> </span><span class=c># 硬件设备的驱动程序信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rootfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span></code></pre></div><ul><li>HostPID：控制 Pod 中容器是否可以共享宿主上的进程 ID 空间</li><li>HostIPC：控制 Pod 容器是否可共享宿主上的 IPC (进程通信)</li><li>hostNetwork: true：Pod 允许使用宿主机网络</li><li>privileged: true：容器以特权方式允许（为了能够访问宿主机所有设备）</li></ul><h3 id=prometheus>prometheus</h3><p><strong>1. 配置文件</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    global:
</span></span></span><span class=line><span class=cl><span class=sd>      scrape_interval: 5s	# 默认抓取间隔
</span></span></span><span class=line><span class=cl><span class=sd>    scrape_configs:
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;prometheus-state-metrics&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      static_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - targets: [&#39;192.168.0.111:32280&#39;]
</span></span></span><span class=line><span class=cl><span class=sd>    - job_name: &#39;node-exporter&#39;
</span></span></span><span class=line><span class=cl><span class=sd>      static_configs:
</span></span></span><span class=line><span class=cl><span class=sd>      - targets: [&#39;192.168.0.111:9100&#39;, &#39;192.168.0.105:9100&#39;]</span><span class=w>    
</span></span></span></code></pre></div><p><strong>2. deployment</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class=l>lain1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># serviceAccountName: myprometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus:v2.30.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--config.file=/config/prometheus.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s2>&#34;--web.enable-lifecycle&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span></code></pre></div><p><strong>3. 更新</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get svc -n prometheus
</span></span><span class=line><span class=cl>NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>    AGE
</span></span><span class=line><span class=cl>prometheus   ClusterIP   10.107.82.59   &lt;none&gt;        9090/TCP   4d6h
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl -X POST http://10.107.82.59:9090/-/reload
</span></span></code></pre></div><h2 id=服务自动发现>服务自动发现</h2><p>Prometheus 添加被监控端有两种方式：</p><ul><li>静态配置：手动配置</li><li>服务发现：动态发现需要监控的实例，服务发现支持来源有 consul_sd_configs、file_sd_configs、kubernetes_sd_configs 等</li></ul><p><strong>1. 创建 RBAC 资源</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myprometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myprometheus-clusterrole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>endpoints</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;extensions&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ingresses</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>configmaps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>nodes/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>nonResourceURLs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myprometheus-clusterrolebinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myprometheus-clusterrole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myprometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span></code></pre></div><p><strong>2. deployment 指定 serviceAccount</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>myprometheus</span><span class=w>
</span></span></span></code></pre></div><p><strong>2. 添加配置</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>5s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;prometheus-state-metrics&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;192.168.0.111:32280&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;k8s-node&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>api_server</span><span class=p>:</span><span class=w> </span><span class=l>https://kubernetes.default.svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># insecure_skip_verify: true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>relabel_configs:	# 在抓取目标之前动态重写目标的标签集</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__address__]	# 源标签从现有标签中选择值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;(.*):10250&#39;</span><span class=w>	</span><span class=c># 与提取的值匹配的正则表达式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;${1}:9100&#39;</span><span class=w> </span><span class=c># 替换值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w> </span><span class=c># 被替换的标签</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace	# 匹配执行的操作(replace 、keep、drop、labelmap、labeldrop)</span><span class=w>
</span></span></span></code></pre></div><h3 id=pod-监控>Pod 监控</h3><p>cAdvisor 负责单节点内部的容器和节点资源使用统计，已经集成在 Kubelet 内部</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看节点lain1统计</span>
</span></span><span class=line><span class=cl>curl https://192.168.0.111:6443/api/v1/nodes/lain1/proxy/metrics/cadvisor <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--header <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$TOKEN</span><span class=s2>&#34;</span> --cacert ca.crt
</span></span></code></pre></div><p>添加配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;kubelet&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>api_server</span><span class=p>:</span><span class=w> </span><span class=l>https://kubernetes.default.svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.default.svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_node_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/nodes/${1}/proxy/metrics/cadvisor</span><span class=w>
</span></span></span></code></pre></div><h2 id=基本查询>基本查询</h2><p><a href=https://prometheus.io/docs/prometheus/latest/querying/basics/ target=_blank rel="noopener noreffer">PromQL</a> (Prometheus Query Language) ，Prometheus的数据查询 DSL 语言</p><p>有四种类型：</p><ul><li>即时向量（instant vector）：包含每个时间序列的单个样本的一组时间序列，共享相同的时间戳</li><li>范围向量（Range vector）：包含每个时间序列随时间变化的数据点的一组时间序列</li><li>标量（Scalar）：一个简单的数字浮点值</li><li>字符串（String）：一个简单的字符串值（目前未被使用）</li></ul><h3 id=即时向量>即时向量</h3><p>url 请求参数：</p><ul><li>query= : PromQL 表达式</li><li>time=&lt;rfc3339 | unix_timestamp> : 用于指定用于计算 PromQL的时间戳。可选参数，默认情况下使用当前系统时间</li></ul><p>示例：</p><p><code>http://10.107.82.59:9090/api/v1/query?query=container_memory_usage_bytes{namespace="default",pod=~"nginx.*"}</code></p><h3 id=区间向量>区间向量</h3><p>区间向量表达式和瞬时向量表达式之间的差异在于需要定义时间范围，通过时间范围选择器 [] 进行定义（s秒 m分钟 h小时 d天 w周 y年）。如：xxx[5m] 查询过去5分钟的数列；xxx{} offset 5m 查询5分钟之前的偏移量</p><p>URL 请求参数：</p><ul><li>query= : PromQL 表达式</li><li>start=&lt;rfc3339 | unix_timestamp> : 起始时间戳</li><li>end=&lt;rfc3339 | unix_timestamp> : 结束时间戳</li><li>step=&lt;duration | float> : 查询时间步长，时间区间内每 step 秒执行一次</li></ul><h3 id=聚合操作符>聚合操作符</h3><p>Prometheus 支持以下内置聚合运算符，这些运算符可以是用于聚合单个即时向量的元素，从而产生新的 具有聚合值的较少元素的向量：</p><ul><li>sum（求和）</li><li>min（最小值）</li><li>max（最大值）</li><li>avg（平均值）</li><li>stddev（标准差）</li><li>stdvar（方差）</li><li>count（元素个数）</li><li>count_values（等于某值的元素个数）</li><li>bottomk（最小的 k 个元素）</li><li>topk（最大的 k 个元素）</li><li>quantile（分位数）</li></ul><h3 id=函数>函数</h3><p>参考：<a href=https://prometheus.io/docs/prometheus/latest/querying/functions/ target=_blank rel="noopener noreffer">查询函数</a>，如：rate(xxx[5m]) 查询指标5分钟内，平均每秒数据</p><h2 id=自定义指标>自定义指标</h2><p>客户端库：<a href=https://github.com/prometheus/client_golang target=_blank rel="noopener noreffer">prometheus/client_golang</a></p><p>四个基本指标类型（时序数据）：</p><ul><li>Counter（计数器）：表示一个单调递增的指标数据，请求次数、错误数量等</li><li>Gauge（计量器）：代表一个可以任意变化的指标数据，可增可减。场景有：协程数量、CPU、Memory 、业务队列的数量等</li><li>Histogram（累积直方图）：主要是样本观测数据,在一段时间范围内对数据进行采样。如请求持续时间或响应大小等，这点往往可以配合链路追踪系统（如 jaeger）</li><li>Summary（摘要统计）：和直方图类似，也是样本观测，但是它提供了样本值的分位数、所有样本值的大小总和、样本总量</li></ul><p>以下是一个计数器自定义指标示例：</p><p><strong>1. 代码</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>prometheus</span><span class=p>.</span><span class=nf>MustRegister</span><span class=p>(</span><span class=nx>prodsVisit</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>var</span> <span class=nx>prodsVisit</span> <span class=p>=</span> <span class=nx>prometheus</span><span class=p>.</span><span class=nf>NewCounterVec</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>prometheus</span><span class=p>.</span><span class=nx>CounterOpts</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Name</span><span class=p>:</span> <span class=s>&#34;lain_prods_visit&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;prod_id&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/prods/visit&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pid_str</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Query</span><span class=p>(</span><span class=s>&#34;pid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>pid_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;error pid&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>prodsVisit</span><span class=p>.</span><span class=nf>With</span><span class=p>(</span><span class=nx>prometheus</span><span class=p>.</span><span class=nx>Labels</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;prod_id&#34;</span><span class=p>:</span> <span class=nx>pid_str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;OK&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>GET</span><span class=p>(</span><span class=s>&#34;/metrics&#34;</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>WrapH</span><span class=p>(</span><span class=nx>promhttp</span><span class=p>.</span><span class=nf>Handler</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>2. 部署</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class=l>lain1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>alpine:3.12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>workingDir</span><span class=p>:</span><span class=w> </span><span class=l>/app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;./prodmetrics&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/home/txl/prometheus/prodmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics</span><span class=w>
</span></span></span></code></pre></div><p><strong>3. prometheus 增加配置</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;lain-prodmetrics&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;prodmetrics&#39;</span><span class=p>]</span><span class=w>	</span><span class=c># service名</span><span class=w>
</span></span></span></code></pre></div><p><strong>4. 重新加载配置</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl -X POST prometheus.prometheus.svc.cluster.local:9090/-/reload
</span></span></code></pre></div><h3 id=自动发现>自动发现</h3><p><strong>1. service 加入注解</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span></code></pre></div><p><strong>2. 修改配置</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;lain-prodmetrics-auto&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>api_server</span><span class=p>:</span><span class=w> </span><span class=l>https://kubernetes.default.svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>service	# 发现类型为service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_scrape]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep	# 丢弃没有匹配到scrape=true的service</span><span class=w>
</span></span></span></code></pre></div><p><strong>3. 重新加载配置</strong></p><h2 id=prometheus-adapter>Prometheus Adapter</h2><p>kubernetes 主要通过两类 API 来获取资源使用指标：</p><ul><li>resource metrics API： 核心组件提供监控指标，如容器 CPU 、内存。 经典的实现就是 metres-server（Group 是 metrics.k8s.io）</li><li>custom metrics API：自定义指标。比较常用的就是 prometheus-adapter，它也支持第一种 API（Group 是 custom.metrics.k8s.io）</li></ul><p>kubernetes apiserver 用于将 kubernetes 的功能通过 restapi 的方式暴露出去，给其他组件使用。对于非核心的功能，k8s 提供对应的 API，具体的实现由第三方软件完成，使用者在使用扩展 apiserver 时，只需要将其注册到 kube-aggregator（kubernetes apiserver 的功能），aggregator 就会将对于这个 api 的请求转发到这个扩展 apiserver 上。Prometheus Adapter 就是一种对 Prometheus adapter 的实现</p><blockquote><p>adapter 是一个聚合 API，它负责把 prometheus 采集的数据爬虫爬回来，放到缓存中，这样就可以通过 k8s api 的方式来查 prometheus 的数据</p></blockquote><h3 id=部署-1>部署</h3><p><strong>1. 创建资源</strong></p><p>参考 <a href=/prometheusAdapter/prometheus-adapter.zip rel>示例 yamls</a></p><p><strong>2. 生成 Secret</strong></p><p>进入 k8s CA 证书所在目录（kubeadm 安装默认在 master 节点的 /etc/kubernetes/pki）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>openssl genrsa -out serving.key <span class=m>2048</span>
</span></span><span class=line><span class=cl>openssl req -new -key serving.key -out serving.csr -subj <span class=s2>&#34;/CN=serving&#34;</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in serving.csr -CA ./ca.crt -CAkey ./ca.key -CAcreateserial -out serving.crt -days <span class=m>3650</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl create secret generic cm-adapter-serving-certs --from-file<span class=o>=</span>serving.crt<span class=o>=</span>./serving.crt --from-file<span class=o>=</span>serving.key -n custom-metrics
</span></span></code></pre></div><p>验证</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get apiservice <span class=p>|</span> grep custom-metrics
</span></span></code></pre></div><p><strong>3. 查看</strong></p><p>如获取 default 命名空间下所有 pod 的 cpu 和内存使用情况</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get --raw <span class=s2>&#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/cpu_usage&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl get --raw <span class=s2>&#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/pods/*/memory_usage_bytes&#34;</span>
</span></span></code></pre></div><h3 id=创建自定义指标>创建自定义指标</h3><p>下面是一个获取所有 prods（上方创建的 lain_prods_visit 指标）1分钟内平均每秒请求数的总和的示例：</p><p><strong>1. 增加 prometheus 配置</strong></p><p>通过抓取的方式移植到服务发现的标签中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;lain-prodmetrics-auto&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/metrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>api_server</span><span class=p>:</span><span class=w> </span><span class=l>https://kubernetes.default.svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_annotation_scrape]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>keep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_namespace]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>namespace	# 移植namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_service_name]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>svcname	# 移植service_name</span><span class=w>
</span></span></span></code></pre></div><p><strong>2. 增加 adapter 配置</strong></p><p>custom-metrics-config-map.yaml：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>seriesQuery</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{__name__=~&#34;^lain_.*&#34;,namespace!=&#34;&#34;}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>seriesFilters</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>overrides</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>namespace</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=l>namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>svcname</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=l>service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>^lain_(.*)$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>as</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metricsQuery</span><span class=p>:</span><span class=w> </span><span class=l>sum(rate(&lt;&lt;.Series&gt;&gt;{&lt;&lt;.LabelMatchers&gt;&gt;}[1m])) by (&lt;&lt;.GroupBy&gt;&gt;)</span><span class=w>
</span></span></span></code></pre></div><ul><li>seriesQuery：用于确定需要查询的指标集合</li><li>seriesFilters：用于过滤指标<ul><li>is: ：匹配包含该正则表达式的 metrics</li><li>isNot: ：匹配不包含该正则表达式的 metrics</li></ul></li><li>resources：把指标的标签和 k8s 的资源类型（必须是真实资源）关联。通过 seriesQuery 查询到的只是指标，如果要查询某个 pod 的指标，肯定要将它的名称和所在的名称空间作为指标的标签进行查询。有两种添加标签的方式，一种是<code>overrides</code>，另一种是 <code>template</code></li><li>name：用来给指标重命名，as 默认值为 $1</li><li>metricsQuery：使用 Go 模板语法将 URL 请求转变为 Prometheus 的请求，常见写法：<code>sum(&lt;&lt;.Series>>{&lt;&lt;.LabelMatchers>>}) by (&lt;&lt;.GroupBy>>)</code><ul><li>Series：metric 名称（如：lain_prods_visit）</li><li>LabelMatchers：附加的标签，是以逗号分割的 objects（如特定命名空间和 resource），因此我们要在之前使用 resources 进行关联</li><li>GroupBy：以逗号分割的 label 的集合（当前表示 LabelMatchers 中的 group-resource label），同样需要使用 resources 进行关联</li></ul></li></ul><p><strong>3. 查询</strong></p><p>通过 metricsQuery 进行查询</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get --raw <span class=s2>&#34;/apis/custom.metrics.k8s.io/v1beta1/namespaces/default/services/prodmetrics/prods_visit&#34;</span>
</span></span></code></pre></div><p>相当于执行了</p><pre tabindex=0><code>sum(rate(lain_prods_visit[1m])) by(svcname)
</code></pre><h2 id=自定义-metrics-hpa>自定义 metrics HPA</h2><p>当 HPA 请求 metrics 时，<code>kube-aggregator</code>（apiservice 的 controller）会将请求转发到 adapter，adapter 作为 Kubernetes 集群的 pod，实现了 Kubernetes resource metrics API 和 custom metrics API，它会根据配置的 rules 从 Prometheus 抓取并处理 metrics，在处理（如重命名 metrics 等）完后将 metric 通过 custom metrics API 返回给 HPA，最后 HPA 通过获取的 metrics 的 value 对 Deployment / ReplicaSet 进行扩缩容</p><p>adapter 作为<code>extension-apiserver（即自己实现的pod）</code>，充当了代理 kube-apiserver 请求 Prometheus 的功能</p><p>下面是一个 HPA 对业务 pod 进行扩容的示例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2beta2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodhpa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics	# 指向上方创建的deploy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Object</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>object</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>metric</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prods_visit	# 指标</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>describedObject</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodmetrics</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>3000m</span><span class=w>
</span></span></span></code></pre></div><h3 id=缩容>缩容</h3><p>在 kube-controller-manager 配置文件中（kubeadm 安装默认在 /etc/kubernetes/manifests/kube-controller-manager.yaml），默认值是5分钟</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>--<span class=l>horizontal-pod-autoscaler-downscale-stabilization=5m</span><span class=w>
</span></span></span></code></pre></div><h2 id=alertmanager>AlertManager</h2><p>Prometheus 将数据采集和报警分成了两个模块。报警规则配置在 Prometheus Servers 上，然后发送报警信息到 AlertManger，然后我们的 AlertManager 就来管理这些报警信息，包括 <strong>silencing</strong>、<strong>inhibition</strong>，聚合报警信息过后通过 email、PagerDuty、HipChat、Slack 等方式发送消息提示</p><h3 id=自定义-webhook>自定义 webhook</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>gin</span><span class=p>.</span><span class=nf>New</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>POST</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>b</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>Request</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;收到告警信息&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>b</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;message&#34;</span><span class=p>:</span> <span class=s>&#34;OK&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=s>&#34;:9090&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-mywebhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-mywebhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-mywebhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class=l>lain1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mywebhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>alpine:3.12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>workingDir</span><span class=p>:</span><span class=w> </span><span class=l>/app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;./alertmanager-mywebhook&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/home/txl/prometheus/alertmanager/webhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-mywebhook</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager-mywebhook</span><span class=w>
</span></span></span></code></pre></div><h3 id=配置文件>配置文件</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 经过此时间后，如果尚未更新告警，则将告警声明为已恢复。(即prometheus没有向alertmanager发送告警了)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resolve_timeout</span><span class=p>:</span><span class=w> </span><span class=l>5m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 配置发送邮件信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>smtp_smarthost</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;smtp.qq.com:465&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>smtp_from</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;742899387@qq.com&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>smtp_auth_username</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;742899387@qq.com&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>smtp_auth_password</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;password&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>smtp_require_tls</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 读取告警通知模板的目录。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>templates</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=s1>&#39;/etc/alertmanager/template/*.tmpl&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 所有报警都会进入到这个根路由下，可以根据根路由下的子路由设置报警分发策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 先解释一下分组，分组就是将多条告警信息聚合成一条发送，这样就不会收到连续的报警了。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 将传入的告警按标签分组(标签在prometheus中的rules中定义)，例如：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 接收到的告警信息里面有许多具有cluster=A 和 alertname=LatencyHigh的标签，这些个告警将被分为一个组。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c>#</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 如果不想使用分组，可以这样写group_by: [...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_by</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;alertname&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;cluster&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;service&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 第一组告警发送通知需要等待的时间，这种方式可以确保有足够的时间为同一分组获取多个告警，然后一起触发这个告警信息。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_wait</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 发送第一个告警后，等待&#34;group_interval&#34;发送一组新告警。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_interval</span><span class=p>:</span><span class=w> </span><span class=l>5m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 分组内发送相同告警的时间间隔。这里的配置是每3小时发送告警到分组中。举个例子：收到告警后，一个分组被创建，等待5分钟发送组内告警，如果后续组内的告警信息相同,这些告警会在3小时后发送，但是3小时内这些告警不会被发送。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repeat_interval</span><span class=p>:</span><span class=w> </span><span class=l>3h </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 这里先说一下，告警发送是需要指定接收器的，接收器在receivers中配置，接收器可以是email、webhook、pagerduty、wechat等等。一个接收器可以有多种发送方式。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 指定默认的接收器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>team-X-mails</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 下面配置的是子路由，子路由的属性继承于根路由(即上面的配置)，在子路由中可以覆盖根路由的配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 下面是子路由的配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 使用正则的方式匹配告警标签</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match_re</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 这里可以匹配出标签含有service=foo1或service=foo2或service=baz的告警</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>^(foo1|foo2|baz)$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 指定接收器为team-X-mails</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>team-X-mails</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 这里配置的是子路由的子路由，当满足父路由的的匹配时，这条子路由会进一步匹配出severity=critical的告警，并使用team-X-pager接收器发送告警，没有匹配到的告警会由父路由进行处理。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>critical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>team-X-pager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 这里也是一条子路由，会匹配出标签含有service=files的告警，并使用team-Y-mails接收器发送告警</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>files</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>team-Y-mails</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 这里配置的是子路由的子路由，当满足父路由的的匹配时，这条子路由会进一步匹配出severity=critical的告警，并使用team-Y-pager接收器发送告警，没有匹配到的会由父路由进行处理。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>critical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>team-Y-pager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 该路由处理来自数据库服务的所有警报。如果没有团队来处理，则默认为数据库团队。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 首先匹配标签service=database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>database</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 指定接收器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>team-DB-pager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 根据受影响的数据库对告警进行分组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>group_by</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>alertname, cluster, database]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>routes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=l>team-X</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>team-X-pager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 告警是否继续匹配后续的同级路由节点，默认false，下面如果也可以匹配成功，会向两种接收器都发送告警信息(猜测。。。)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>continue</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=l>team-Y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=l>team-Y-pager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 下面是关于inhibit(抑制)的配置，先说一下抑制是什么：抑制规则允许在另一个警报正在触发的情况下使一组告警静音。其实可以理解为告警依赖。比如一台数据库服务器掉电了，会导致db监控告警、网络告警等等，可以配置抑制规则如果服务器本身down了，那么其他的报警就不会被发送出来。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>inhibit_rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c>#下面配置的含义：当有多条告警在告警组里时，并且他们的标签alertname,cluster,service都相等，如果severity: &#39;critical&#39;的告警产生了，那么就会抑制severity: &#39;warning&#39;的告警。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>  </span><span class=c># 源告警(我理解是根据这个报警来抑制target_match中匹配的告警)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;critical&#39;</span><span class=w> </span><span class=c># 标签匹配满足severity=critical的告警作为源告警</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>target_match</span><span class=p>:</span><span class=w>  </span><span class=c># 目标告警(被抑制的告警)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;warning&#39;</span><span class=w>  </span><span class=c># 告警必须满足标签匹配severity=warning才会被抑制。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>equal</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;alertname&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;cluster&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;service&#39;</span><span class=p>]</span><span class=w>  </span><span class=c># 必须在源告警和目标告警中具有相等值的标签才能使抑制生效。(即源告警和目标告警中这三个标签的值相等&#39;alertname&#39;, &#39;cluster&#39;, &#39;service&#39;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 下面配置的是接收器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 接收器的名称、通过邮件的方式发送、</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;team-X-mails&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>email_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 发送给哪些人</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;team-X+alerts@example.org&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 是否通知已解决的警报</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>send_resolved</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 接收器的名称、通过邮件和pagerduty的方式发送、发送给哪些人，指定pagerduty的service_key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;team-X-pager&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>email_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;team-X+alerts-critical@example.org&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pagerduty_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>service_key</span><span class=p>:</span><span class=w> </span><span class=l>&lt;team-X-key&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 接收器的名称、通过邮件的方式发送、发送给哪些人</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;team-Y-mails&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>email_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;team-Y+alerts@example.org&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 接收器的名称、通过pagerduty的方式发送、指定pagerduty的service_key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;team-Y-pager&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pagerduty_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>service_key</span><span class=p>:</span><span class=w> </span><span class=l>&lt;team-Y-key&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 一个接收器配置多种发送方式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;ops&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>webhook_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://prometheus-webhook-dingtalk.kube-ops.svc.cluster.local:8060/dingtalk/webhook1/send&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>send_resolved</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>email_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;742899387@qq.com&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>send_resolved</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>to</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;soulchild@soulchild.cn&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>send_resolved</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><h3 id=部署-2>部署</h3><p><strong>1. 配置</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alertmanager.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    route:	# 根路由
</span></span></span><span class=line><span class=cl><span class=sd>      receiver: &#39;test-receiver&#39;	# 根路由接收者（还可以设置子路由)
</span></span></span><span class=line><span class=cl><span class=sd>      group_wait: 30s		# 下面时间内如果接收到多个报警，则会合并成一个通知发送给receiver
</span></span></span><span class=line><span class=cl><span class=sd>      group_interval: 1m	# 两次报警通知的时间间隔
</span></span></span><span class=line><span class=cl><span class=sd>      repeat_interval: 2m	# 发送相同告警的时间间隔
</span></span></span><span class=line><span class=cl><span class=sd>      group_by: [alertname]	# 分组规则
</span></span></span><span class=line><span class=cl><span class=sd>    receivers:	# 定义所有接收者
</span></span></span><span class=line><span class=cl><span class=sd>    - name: &#39;test-receiver&#39;	# 接收者名称
</span></span></span><span class=line><span class=cl><span class=sd>      webhook_configs:		# 设置为webhook类型
</span></span></span><span class=line><span class=cl><span class=sd>      - url: &#39;http://alertmanager-mywebhook/&#39;</span><span class=w>    
</span></span></span></code></pre></div><ul><li>路由（route）：用于配置 Alertmanager 如何处理传入的特定类型的告警通知，其基本逻辑是根据路由匹配规则的匹配结果来确定处理当前报警通知的路径和行为</li><li>分组（grouping）：根据 prometheus 的 lables 进行报警分组，这些警报会合并为一个通知发送给接收器。在生产环境中，特别是云环境下的业务之间密集耦合时，若出现多台 Instance 故障，可能会导致成千上百条警报触发。在这种情况下使用分组机制，可以把这些被触发的警报合并为一个警报进行通知，从而避免瞬间突发性的接受大量警报通知</li></ul><p><strong>2. 工作负载</strong></p><p>可以通过启动参数 <code>--config.file</code> 来指定配置文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>nodeName</span><span class=p>:</span><span class=w> </span><span class=l>lain1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/alertmanager:v0.22.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9093</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9093</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9093</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>alertmanager</span><span class=w>
</span></span></span></code></pre></div><p><strong>3. 配置 prometheus 和 alertManager 通信</strong></p><p>修改 prometheus 的配置，加入内容</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;alertmanager:9093&#34;</span><span class=p>]</span><span class=w>  
</span></span></span></code></pre></div><h3 id=在-prometheus-中创建报警规则>在 prometheus 中创建报警规则</h3><p>创建一个基于自定义指标的报警规则配置，如果2分钟内每个商品的平均每秒访问量总和超过0.5，然后会发送报警信息 POST 到提供的 webHook 中</p><p>一个报警信息在生命周期内有下面3中状态：</p><ul><li>inactive: 表示当前报警信息既不是<code>firing</code>状态也不是<code>pending</code>状态</li><li>pending: 表示在设置的阈值时间范围内被激活了</li><li>firing: 表示超过设置的阈值时间被激活了</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>prodrule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prodrule.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    groups:
</span></span></span><span class=line><span class=cl><span class=sd>    - name: prods
</span></span></span><span class=line><span class=cl><span class=sd>      rules:
</span></span></span><span class=line><span class=cl><span class=sd>      - alert: prodsvisit	# 报警名称
</span></span></span><span class=line><span class=cl><span class=sd>        expr: sum(rate(lain_prods_visit[2m])) &gt; 0.5	# PromQL表达式，用于指定情况规则属于告警范围
</span></span></span><span class=line><span class=cl><span class=sd>        for: 10s	# 告警持续时间，超过会推送给 Alertmanager
</span></span></span><span class=line><span class=cl><span class=sd>        labels:		# 自定义标签
</span></span></span><span class=line><span class=cl><span class=sd>          level: warning
</span></span></span><span class=line><span class=cl><span class=sd>        annotations:	# 自定义注释
</span></span></span><span class=line><span class=cl><span class=sd>          summary: &#34;商品访问量飙升&#34;
</span></span></span><span class=line><span class=cl><span class=sd>          description: &#34; 商品访问量飙升，预估值：{{ $value }}&#34;</span><span class=w>    
</span></span></span></code></pre></div><p>把 ConfigMap 挂载到 prometheus 工作负载里</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>       
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rules</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/rules	// 映射到/rules/prodrule.yaml</span><span class=w>
</span></span></span></code></pre></div><p>同时在 prometheus 配置里添加报警规则文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;/rules/prodrule.yaml&#34;</span><span class=w>  
</span></span></span></code></pre></div><h3 id=模板>模板</h3><p>警报模板可以自定义通知的信息格式，以及其包含的对应警报指标数据，可以自定义 Email、企业微信的模板，配置指定的存放位置，这里的模板是指的发送的通知源信息格式模板，比如 Email，企业微信</p><p>示例模板</p><pre tabindex=0><code>{{ define &#34;wechattpl&#34; }}
{{ range $i, $alert :=.Alerts }}
{{ if eq .Status &#34;resolved&#34; }}
========监控报警---解决了==========
{{ else }}
========监控报警---发现警报==========
{{ end }}
告警状态：{{   .Status }}
告警级别：{{ $alert.Labels.level }}
告警类型：{{ $alert.Labels.alertname }}
告警应用：{{ $alert.Annotations.summary }}
告警详情：{{ $alert.Annotations.description }}
告警时间：{{ $alert.StartsAt.Format &#34;2006-01-02 15:04:05&#34; }}
========end=============
{{ end }}
{{ end }}
</code></pre><p>修改 alertManager 配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;test&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_wait</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repeat_interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_by</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>alertname]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>templates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s1>&#39;/tpl/*.tpl&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;test&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wechat_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>corp_id</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to_party</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>agent_id</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>api_secret</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ template &#34;wechattpl&#34; . }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>send_resolved</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>	</span><span class=c># 恢复时也发送消息</span><span class=w>
</span></span></span></code></pre></div><p>然后映射模板文件到 alertManager 工作负载的 /tpl 目录</p><h3 id=子路由>子路由</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>route</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;test&#39;</span><span class=w>	</span><span class=c># 默认的接收者</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_wait</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repeat_interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>group_by</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>alertname]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>routes:	# 根据根路由下的子路由设置报警分发策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>receiver</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;abc&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>match_re:		# 使用正则的方式匹配告警标签</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;danger&#39;</span><span class=w>	</span><span class=c># 匹配到label时发送给指定的接收者</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>templates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s1>&#39;/tpl/*.tpl&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>receivers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;abc&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>webhook_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;http://192.168.0.106:9091/&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;test&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>wechat_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>corp_id</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>to_party</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>agent_id</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>api_secret</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>message</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;{{ template &#34;abc&#34; . }}&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>send_resolved</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><h3 id=静默>静默</h3><p>静默（Silences）提供了一个简单的机制，根据标签快速对警报进行静默处理；对传进来的警报进行匹配检查，如果接受到警报符合静默的配置，Alertmanager 则不会发送警报通知。静默是需要在 WEB UI 界面中设置临时屏蔽指定的警报通知</p><h3 id=告警抑制>告警抑制</h3><p>抑制（Inhibition）是当某条警报已经发送，停止重复发送由此警报引发的其他异常或故障的警报机制。在我们的灾备体系中，当原有集群故障宕机业务彻底无法访问的时候，会把用户流量切换到备份集群中，这样为故障集群及其提供的各个微服务状态发送警报机会失去了意义，此时， Alertmanager 的抑制特性就可以在一定程度上避免管理员收到过多无用的警报通知</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>inhibit_rules:	# 如果level: &#39;danger&#39;的告警产生了，level</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;warning&#39;</span><span class=l>的告警</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>source_match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;danger&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>target_match</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;warning&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>equal</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;kind&#34;</span><span class=p>]</span><span class=w>	</span><span class=c># 必须在源告警和目标告警中的kind标签值相等时才使抑制生效</span><span class=w>
</span></span></span></code></pre></div><h3 id=amtool>amtool</h3><p>amtool 是用于与 Alertmanager API 交互的 cli 工具</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看所有当前触发的警报</span>
</span></span><span class=line><span class=cl>amtool --alertmanager.url<span class=o>=</span>http://localhost:9093 alert
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 模拟创建一个警报</span>
</span></span><span class=line><span class=cl>amtool --alertmanager.url<span class=o>=</span>http://localhost:9093 alert add <span class=nv>level</span><span class=o>=</span>danger <span class=nv>kind</span><span class=o>=</span>prods <span class=nv>alertname</span><span class=o>=</span><span class=s2>&#34;svcdwn&#34;</span> --annotation<span class=o>=</span><span class=nv>description</span><span class=o>=</span><span class=s2>&#34;service down&#34;</span> --annotation<span class=o>=</span><span class=nv>summary</span><span class=o>=</span><span class=s2>&#34;summary&#34;</span>
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-23&nbsp;<a class=git-hash href=https://github.com/xuliangTang/xuliangTang.github.io/commit/647073b8f5709f548a5b89d60705d3623f726467 target=_blank title="commit by Lain(1297441127@qq.com) 647073b8f5709f548a5b89d60705d3623f726467: update: prometheus">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>647073b</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://xuliangtang.github.io/posts/prometheus/ data-title="Prometheus 入门"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://xuliangtang.github.io/posts/prometheus/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://xuliangtang.github.io/posts/prometheus/ data-title="Prometheus 入门"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://xuliangtang.github.io/posts/prometheus/ data-title="Prometheus 入门"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://xuliangtang.github.io/posts/prometheus/ data-title="Prometheus 入门"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/operator/ class=prev rel=prev title="使用 kubebuilder 开发 Operator"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>使用 kubebuilder 开发 Operator</a>
<a href=/posts/fluent-bit/ class=next rel=next title="Fluent Bit 日志收集">Fluent Bit 日志收集<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.108.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xuliangTang</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"4ZKRIKL2L6",algoliaIndex:"dev_lain",algoliaSearchKey:"2da9b5e339083fde5fe030c2345f5499",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:80,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>