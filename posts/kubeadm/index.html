<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>ä½¿ç”¨ kubeadm éƒ¨ç½² k8s - Lain Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="ä½¿ç”¨ kubeadm éƒ¨ç½² k8s"><meta property="og:description" content="kubeadmæ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤çš„å·¥å…· éƒ¨ç½² æ–‡æ¡£åœ°å€ï¼šå®‰è£… kubeadm | Kubernetes æ·»åŠ  kubenetes çš„ yum æº åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ†åˆ«æ‰§è¡Œ $ su - $"><meta property="og:type" content="article"><meta property="og:url" content="http://xuliangtang.github.io/posts/kubeadm/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-14T22:37:46+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="ä½¿ç”¨ kubeadm éƒ¨ç½² k8s"><meta name=twitter:description content="kubeadmæ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤çš„å·¥å…· éƒ¨ç½² æ–‡æ¡£åœ°å€ï¼šå®‰è£… kubeadm | Kubernetes æ·»åŠ  kubenetes çš„ yum æº åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ†åˆ«æ‰§è¡Œ $ su - $"><meta name=application-name content="Lain Blog"><meta name=apple-mobile-web-app-title content="Lain Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://xuliangtang.github.io/posts/kubeadm/><link rel=next href=http://xuliangtang.github.io/posts/rbac/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ä½¿ç”¨ kubeadm éƒ¨ç½² k8s","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/xuliangtang.github.io\/posts\/kubeadm\/"},"genre":"posts","wordcount":980,"url":"http:\/\/xuliangtang.github.io\/posts\/kubeadm\/","datePublished":"2022-12-03T00:00:00+00:00","dateModified":"2022-12-14T22:37:46+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xuliangTang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>æ–‡ç«  </a><a class=menu-item href=/tags/>æ ‡ç­¾ </a><a class=menu-item href=/categories/>åˆ†ç±» </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>æ–‡ç« </a><a class=menu-item href=/tags/ title>æ ‡ç­¾</a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ä½¿ç”¨ kubeadm éƒ¨ç½² k8s</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xuliangTang</a></span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-12-03>2022-12-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;980 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;2 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#éƒ¨ç½²>éƒ¨ç½²</a><ul><li><a href=#æ·»åŠ -kubenetes-çš„-yum-æº>æ·»åŠ  kubenetes çš„ yum æº</a></li><li><a href=#å®‰è£…-kubeadmkubelet-å’Œ-kubectl>å®‰è£… kubeadmã€kubelet å’Œ kubectl</a></li><li><a href=#ä½¿ç”¨-systemd-ä½œä¸º-docker-çš„-cgroup-driver>ä½¿ç”¨ systemd ä½œä¸º docker çš„ cgroup driver</a></li><li><a href=#å…³é—­-swap>å…³é—­ swap</a></li><li><a href=#åˆå§‹åŒ–é›†ç¾¤>åˆå§‹åŒ–é›†ç¾¤</a></li><li><a href=#å®‰è£…ç½‘ç»œç»„ä»¶>å®‰è£…ç½‘ç»œç»„ä»¶</a></li><li><a href=#åŠ å…¥å­èŠ‚ç‚¹>åŠ å…¥å­èŠ‚ç‚¹</a></li><li><a href=#æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶å†µ>æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶å†µ</a></li></ul></li><li><a href=#å°†é›†ç¾¤å¯¼å…¥-rancher>å°†é›†ç¾¤å¯¼å…¥ Rancher</a></li></ul></nav></div></div><div class=content id=content><p>kubeadmæ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½²kubernetesé›†ç¾¤çš„å·¥å…·</p><h2 id=éƒ¨ç½²>éƒ¨ç½²</h2><p>æ–‡æ¡£åœ°å€ï¼š<a href=https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm target=_blank rel="noopener noreffer">å®‰è£… kubeadm | Kubernetes</a></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png title=image-20221203185600145></p><h3 id=æ·»åŠ -kubenetes-çš„-yum-æº>æ·»åŠ  kubenetes çš„ yum æº</h3><p>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ†åˆ«æ‰§è¡Œ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ su -
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class=line><span class=cl><span class=s>[kubernetes]
</span></span></span><span class=line><span class=cl><span class=s>name=Kubernetes
</span></span></span><span class=line><span class=cl><span class=s>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span class=line><span class=cl><span class=s>enabled=1
</span></span></span><span class=line><span class=cl><span class=s>gpgcheck=0
</span></span></span><span class=line><span class=cl><span class=s>repo_gpgcheck=0
</span></span></span><span class=line><span class=cl><span class=s>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span class=line><span class=cl><span class=s>        https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ yum makecache
</span></span></code></pre></div><h3 id=å®‰è£…-kubeadmkubelet-å’Œ-kubectl>å®‰è£… kubeadmã€kubelet å’Œ kubectl</h3><p>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ†åˆ«æ‰§è¡Œ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo yum install -y kubelet-1.21.0 kubeadm-1.21.0 kubectl-1.21.0
</span></span></code></pre></div><p>å®‰è£…åæŸ¥çœ‹åˆ—è¡¨</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ rpm -aq kubelet kubectl kubeadm
</span></span></code></pre></div><p>æŠŠkubeletè®¾ç½®ä¸ºå¼€æœºå¯åŠ¨</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo systemctl <span class=nb>enable</span> kubelet
</span></span></code></pre></div><blockquote><p><code>kubeadm init</code> é›†ç¾¤çš„å¿«é€Ÿåˆå§‹åŒ–ï¼Œéƒ¨ç½²MasterèŠ‚ç‚¹çš„å„ä¸ªç»„ä»¶</p><p><code>kubeadm join</code> èŠ‚ç‚¹åŠ å…¥åˆ°æŒ‡å®šé›†ç¾¤ä¸­</p><p><code>kubeadm token</code> ç®¡ç†ç”¨äºåŠ å…¥é›†ç¾¤æ—¶ä½¿ç”¨çš„è®¤è¯ä»¤ç‰Œ (å¦‚listï¼Œcreate)</p><p><code>kubeadm reset</code> é‡ç½®é›†ç¾¤ï¼Œå¦‚åˆ é™¤æ„å»ºæ–‡ä»¶ä»¥å›åˆ°åˆå§‹çŠ¶æ€</p></blockquote><h3 id=ä½¿ç”¨-systemd-ä½œä¸º-docker-çš„-cgroup-driver>ä½¿ç”¨ systemd ä½œä¸º docker çš„ cgroup driver</h3><p>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo vi  /etc/docker/daemon.json
</span></span></code></pre></div><p>åŠ å…¥å†…å®¹</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;exec-opts&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;native.cgroupdriver=systemd&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>é‡å¯docker</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ systemctl daemon-reload  <span class=o>&amp;&amp;</span> systemctl restart docker
</span></span></code></pre></div><p>éªŒè¯ç»“æœ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ docker info <span class=p>|</span>grep Cgroup
</span></span><span class=line><span class=cl> Cgroup Driver: systemd
</span></span><span class=line><span class=cl> Cgroup Version: <span class=m>1</span>
</span></span></code></pre></div><h3 id=å…³é—­-swap>å…³é—­ swap</h3><ul><li>ä¸´æ—¶å…³é—­</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ swapoff -a
</span></span></code></pre></div><ul><li>æ°¸ä¹…å…³é—­</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo vi /etc/fstab
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ³¨é‡Šæ‰SWAPåˆ†åŒºé¡¹</span>
</span></span><span class=line><span class=cl><span class=c1># swap was on /dev/sda11 during installation</span>
</span></span><span class=line><span class=cl><span class=c1># UUID=0xxxxxxxxxxxxxx4f69 none  swap    sw      0       0</span>
</span></span></code></pre></div><h3 id=åˆå§‹åŒ–é›†ç¾¤>åˆå§‹åŒ–é›†ç¾¤</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo kubeadm init --kubernetes-version<span class=o>=</span>v1.21.0  --image-repository registry.aliyuncs.com/google_containers --pod-network-cidr<span class=o>=</span>10.244.0.0/16
</span></span></code></pre></div><p>æ ¹æ®è¾“å‡ºæç¤ºæ“ä½œ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>$ sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>$ sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span></code></pre></div><p>é»˜è®¤tokençš„æœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œå½“è¿‡æœŸä¹‹åï¼Œè¯¥tokenå°±ä¸å¯ç”¨äº†ã€‚</p><p><strong>æŸ¥çœ‹tokenåˆ—è¡¨ï¼š</strong> <code>$ sudo kubeadm token list</code></p><p><strong>é‡æ–°ç”Ÿæˆtokenï¼š</strong> <code>$ sudo kubeadm token create --print-join-command</code></p><h3 id=å®‰è£…ç½‘ç»œç»„ä»¶>å®‰è£…ç½‘ç»œç»„ä»¶</h3><h4 id=cni-container-network-interface>CNI (Container Network Interface)</h4><p>å®¹å™¨ç½‘ç»œæ¥å£ï¼Œä¸ºäº†è®©ç”¨æˆ·åœ¨å®¹å™¨åˆ›å»ºæˆ–é”€æ¯æ—¶éƒ½èƒ½å¤Ÿæ›´å®¹æ˜“åœ°é…ç½®å®¹å™¨ç½‘ç»œã€‚å¸¸è§çš„ç»„ä»¶æœ‰ï¼š</p><ul><li>Flannel: æœ€åŸºæœ¬çš„ç½‘ç»œç»„ä»¶</li><li>Calico: æ”¯æŒç½‘ç»œç­–ç•¥</li><li>Canal: å‰ä¸¤è€…çš„åˆä½“</li><li>Weave: åŒæ ·æ”¯æŒç­–ç•¥æœºåˆ¶ï¼Œè¿˜æ”¯æŒåŠ å¯†</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png title=image-20221203185630984></p><h4 id=ä½¿ç”¨-flannel>ä½¿ç”¨ flannel</h4><p>Githubåœ°å€ï¼š<a href=https://github.com/coreos/flannel target=_blank rel="noopener noreffer">https://github.com/coreos/flannel</a></p><p>åœ¨æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œ</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png title=image-20221203185728214></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo sysctl net.bridge.bridge-nf-call-iptables<span class=o>=</span><span class=m>1</span>
</span></span></code></pre></div><p>åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å»æ±¡ç‚¹</span>
</span></span><span class=line><span class=cl>$ kubectl taint nodes --all node-role.kubernetes.io/master-
</span></span></code></pre></div><p>æŸ¥çœ‹</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get pods --all-namespaces
</span></span></code></pre></div><h4 id=å¯èƒ½å‡ºç°çš„é”™è¯¯>å¯èƒ½å‡ºç°çš„é”™è¯¯</h4><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png title=image-20221203185645566></p><p>åŸºæœ¬æ’æŸ¥å‘½ä»¤</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl describe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ journalctl -f -u kubelet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ <span class=k>for</span> p in <span class=k>$(</span>kubectl get pods --namespace<span class=o>=</span>kube-system -l k8s-app<span class=o>=</span>kube-dns -o name<span class=k>)</span><span class=p>;</span> <span class=k>do</span> kubectl logs --namespace<span class=o>=</span>kube-system <span class=nv>$p</span><span class=p>;</span> <span class=k>done</span>
</span></span></code></pre></div><h5 id=coredns>coredns</h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl describe pod -n kube-system coredns-xxx
</span></span></code></pre></div><blockquote><p>network: open /run/flannel/subnet.env: no such file or directory</p></blockquote><p>æ‰‹åŠ¨åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»º</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo vi /run/flannel/subnet.env
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åŠ å…¥å†…å®¹</span>
</span></span><span class=line><span class=cl><span class=nv>FLANNEL_NETWORK</span><span class=o>=</span>10.244.0.0/16
</span></span><span class=line><span class=cl><span class=nv>FLANNEL_SUBNET</span><span class=o>=</span>10.244.0.1/24
</span></span><span class=line><span class=cl><span class=nv>FLANNEL_MTU</span><span class=o>=</span><span class=m>1450</span>
</span></span><span class=line><span class=cl><span class=nv>FLANNEL_IPMASQ</span><span class=o>=</span><span class=nb>true</span>
</span></span></code></pre></div><blockquote><p>&ldquo;cni0&rdquo; already has an IP address different from 10.244.1.1/24</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo ip link delete cni0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é‡å¯pod</span>
</span></span><span class=line><span class=cl>$ kubectl delete pod xxx
</span></span></code></pre></div><blockquote><p>Readiness probe failed: HTTP probe failed with statuscode: 503</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ systemctl stop kubelet
</span></span><span class=line><span class=cl>$ systemctl stop docker
</span></span><span class=line><span class=cl>$ iptables --flush
</span></span><span class=line><span class=cl>$ iptables -tnat --flush
</span></span><span class=line><span class=cl>$ systemctl start kubelet
</span></span><span class=line><span class=cl>$ systemctl start docker
</span></span></code></pre></div><h5 id=èŠ‚ç‚¹-not-ready>èŠ‚ç‚¹ not ready</h5><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png title=image-20221203185744006></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl describe node lain2
</span></span></code></pre></div><blockquote><p>failed to find plugin &ldquo;xxx&rdquo; in path [/opt/cni/bin]</p></blockquote><p>æŠŠmasterèŠ‚ç‚¹çš„ <code>/opt/cni/bin</code> æ‹·è´è¿‡æ¥ï¼Œåœ¨masterèŠ‚ç‚¹æ‰§è¡Œ</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>cd</span> /opt/cni
</span></span><span class=line><span class=cl>$ sudo scp -r bin root@192.168.0.105:/opt/cni/bin
</span></span></code></pre></div><p>åŸå› å¯èƒ½æ˜¯é‡è£…k8sçš„æ—¶å€™æ²¡æœ‰åˆ é™¤ <code>/etc/cni/net.d</code> ç›®å½•</p><h3 id=åŠ å…¥å­èŠ‚ç‚¹>åŠ å…¥å­èŠ‚ç‚¹</h3><p>åœ¨æ¯ä¸ªnodeèŠ‚ç‚¹æ‰§è¡Œåˆšåˆšåˆå§‹åŒ–é›†ç¾¤æ—¶ç”Ÿæˆçš„token</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo kubeadm join 192.168.0.111:6443 --token fnq8dx.doxwr7sctdm57p0t <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --discovery-token-ca-cert-hash sha256:114acfe6e30bc0181a93b9135296af62c5f946fa590691577071a4ebf21fc3ee
</span></span></code></pre></div><h3 id=æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶å†µ>æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶å†µ</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get cs
</span></span></code></pre></div><blockquote><p>controller-manager && scheduler Unhealthy: dial tcp 127.0.0.1:10252 connection refuse</p></blockquote><p>åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ</p><pre tabindex=0><code>$ sudo vi /etc/kubernetes/manifests/kube-scheduler.yaml
$ sudo vi /etc/kubernetes/manifests/kube-controller-manager.yaml

# æ³¨é‡Š
# - --port=0

# é‡å¯kublet
$ systemctl restart kubelet
</code></pre><h2 id=å°†é›†ç¾¤å¯¼å…¥-rancher>å°†é›†ç¾¤å¯¼å…¥ Rancher</h2><p>æ‰¾ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œä¸‹è½½v2.6</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo docker run --privileged -d --restart<span class=o>=</span>unless-stopped -p 80:80 -p 443:443 rancher/rancher:v2.6-head
</span></span></code></pre></div><p>æ ¹æ®æŒ‡å¼•æ‰§è¡Œå‘½ä»¤</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-12-14&nbsp;<a class=git-hash href=https://github.com/xuliangTang/xuliangTang.github.io/commit/2856aa864f09517d7a48e82c5e7aec21a5b7427d target=_blank title="commit by xuliangTang(1297441127@qq.com) 2856aa864f09517d7a48e82c5e7aec21a5b7427d: ğŸ‰ Initial Commit">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>2856aa8</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://xuliangtang.github.io/posts/kubeadm/ data-title="ä½¿ç”¨ kubeadm éƒ¨ç½² k8s"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://xuliangtang.github.io/posts/kubeadm/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://xuliangtang.github.io/posts/kubeadm/ data-title="ä½¿ç”¨ kubeadm éƒ¨ç½² k8s"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://xuliangtang.github.io/posts/kubeadm/ data-title="ä½¿ç”¨ kubeadm éƒ¨ç½² k8s"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on å¾®åš" data-sharer=weibo data-url=http://xuliangtang.github.io/posts/kubeadm/ data-title="ä½¿ç”¨ kubeadm éƒ¨ç½² k8s"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/rbac/ class=next rel=next title="K8s è®¤è¯å’Œæˆæƒ">K8s è®¤è¯å’Œæˆæƒ<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.108.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xuliangTang</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{},search:{algoliaAppID:"4ZKRIKL2L6",algoliaIndex:"dev_lain",algoliaSearchKey:"2da9b5e339083fde5fe030c2345f5499",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:80,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>