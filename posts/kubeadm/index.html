<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>使用 kubeadm 部署 k8s - Lain Blog</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="使用 kubeadm 部署 k8s" />
<meta property="og:description" content="kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具 部署 文档地址：安装 kubeadm | Kubernetes 添加 kubenetes 的 yum 源 在每个节点上分别执行 $ su - $" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/kubeadm/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-12-03T00:00:00+00:00" /><meta property="og:site_name" content="My cool site" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用 kubeadm 部署 k8s"/>
<meta name="twitter:description" content="kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具 部署 文档地址：安装 kubeadm | Kubernetes 添加 kubenetes 的 yum 源 在每个节点上分别执行 $ su - $"/>
<meta name="application-name" content="Lain Blog">
<meta name="apple-mobile-web-app-title" content="Lain Blog"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/posts/kubeadm/" /><link rel="next" href="http://example.org/posts/rbac/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "使用 kubeadm 部署 k8s",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/posts\/kubeadm\/"
        },"genre": "posts","wordcount":  980 ,
        "url": "http:\/\/example.org\/posts\/kubeadm\/","datePublished": "2022-12-03T00:00:00+00:00","dateModified": "2022-12-03T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "xuliangTang"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Lain Blog">Dev Lain</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Lain Blog">Dev Lain</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">使用 kubeadm 部署 k8s</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>xuliangTang</a></span>&nbsp;<span class="post-category">included in <a href="/categories/kubernetes/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>kubernetes</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-12-03">2022-12-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;980 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;2 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#部署">部署</a>
      <ul>
        <li><a href="#添加-kubenetes-的-yum-源">添加 kubenetes 的 yum 源</a></li>
        <li><a href="#安装-kubeadmkubelet-和-kubectl">安装 kubeadm、kubelet 和 kubectl</a></li>
        <li><a href="#使用-systemd-作为-docker-的-cgroup-driver">使用 systemd 作为 docker 的 cgroup driver</a></li>
        <li><a href="#关闭-swap">关闭 swap</a></li>
        <li><a href="#初始化集群">初始化集群</a></li>
        <li><a href="#安装网络组件">安装网络组件</a></li>
        <li><a href="#加入子节点">加入子节点</a></li>
        <li><a href="#查看集群健康状况">查看集群健康状况</a></li>
      </ul>
    </li>
    <li><a href="#将集群导入-rancher">将集群导入 Rancher</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>kubeadm是官方社区推出的一个用于快速部署kubernetes集群的工具</p>
<h2 id="部署">部署</h2>
<p>文档地址：<a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm" target="_blank" rel="noopener noreffer ">安装 kubeadm | Kubernetes</a></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png"
        data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185600145.png"
        title="image-20221203185600145" /></p>
<h3 id="添加-kubenetes-的-yum-源">添加 kubenetes 的 yum 源</h3>
<p>在每个节点上分别执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ su -
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ cat <span class="s">&lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class="line"><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="cl"><span class="s">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span class="line"><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s">repo_gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">        https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ yum makecache
</span></span></code></pre></div><h3 id="安装-kubeadmkubelet-和-kubectl">安装 kubeadm、kubelet 和 kubectl</h3>
<p>在每个节点上分别执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo yum install -y kubelet-1.21.0 kubeadm-1.21.0 kubectl-1.21.0
</span></span></code></pre></div><p>安装后查看列表</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ rpm -aq kubelet kubectl kubeadm
</span></span></code></pre></div><p>把kubelet设置为开机启动</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo systemctl <span class="nb">enable</span> kubelet
</span></span></code></pre></div><blockquote>
<p><code>kubeadm init</code> 集群的快速初始化，部署Master节点的各个组件</p>
<p><code>kubeadm join</code> 节点加入到指定集群中</p>
<p><code>kubeadm token</code> 管理用于加入集群时使用的认证令牌 (如list，create)</p>
<p><code>kubeadm reset</code> 重置集群，如删除构建文件以回到初始状态</p>
</blockquote>
<h3 id="使用-systemd-作为-docker-的-cgroup-driver">使用 systemd 作为 docker 的 cgroup driver</h3>
<p>在每个节点上执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo vi  /etc/docker/daemon.json
</span></span></code></pre></div><p>加入内容</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;exec-opts&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;native.cgroupdriver=systemd&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>重启docker</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ systemctl daemon-reload  <span class="o">&amp;&amp;</span> systemctl restart docker
</span></span></code></pre></div><p>验证结果</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker info <span class="p">|</span>grep Cgroup
</span></span><span class="line"><span class="cl"> Cgroup Driver: systemd
</span></span><span class="line"><span class="cl"> Cgroup Version: <span class="m">1</span>
</span></span></code></pre></div><h3 id="关闭-swap">关闭 swap</h3>
<ul>
<li>临时关闭</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ swapoff -a
</span></span></code></pre></div><ul>
<li>永久关闭</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo vi /etc/fstab
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 注释掉SWAP分区项</span>
</span></span><span class="line"><span class="cl"><span class="c1"># swap was on /dev/sda11 during installation</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UUID=0xxxxxxxxxxxxxx4f69 none  swap    sw      0       0</span>
</span></span></code></pre></div><h3 id="初始化集群">初始化集群</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo kubeadm init --kubernetes-version<span class="o">=</span>v1.21.0  --image-repository registry.aliyuncs.com/google_containers --pod-network-cidr<span class="o">=</span>10.244.0.0/16
</span></span></code></pre></div><p>根据输出提示操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">$ sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">$ sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span></code></pre></div><p>默认token的有效期为24小时，当过期之后，该token就不可用了。</p>
<p><strong>查看token列表：</strong> <code>$ sudo kubeadm token list</code></p>
<p><strong>重新生成token：</strong> <code>$ sudo kubeadm token create  --print-join-command</code></p>
<h3 id="安装网络组件">安装网络组件</h3>
<h4 id="cni-container-network-interface">CNI (Container Network Interface)</h4>
<p>容器网络接口，为了让用户在容器创建或销毁时都能够更容易地配置容器网络。常见的组件有：</p>
<ul>
<li>Flannel: 最基本的网络组件</li>
<li>Calico: 支持网络策略</li>
<li>Canal: 前两者的合体</li>
<li>Weave: 同样支持策略机制，还支持加密</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png"
        data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185630984.png"
        title="image-20221203185630984" /></p>
<h4 id="使用-flannel">使用 flannel</h4>
<p>Github地址：<a href="https://github.com/coreos/flannel" target="_blank" rel="noopener noreffer ">https://github.com/coreos/flannel</a></p>
<p>在每个节点执行</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png"
        data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185728214.png"
        title="image-20221203185728214" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo sysctl net.bridge.bridge-nf-call-iptables<span class="o">=</span><span class="m">1</span>
</span></span></code></pre></div><p>在master节点执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 去污点</span>
</span></span><span class="line"><span class="cl">$ kubectl taint nodes --all node-role.kubernetes.io/master-
</span></span></code></pre></div><p>查看</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get pods --all-namespaces
</span></span></code></pre></div><h4 id="可能出现的错误">可能出现的错误</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png"
        data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185645566.png"
        title="image-20221203185645566" /></p>
<p>基本排查命令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl describe
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ journalctl -f -u kubelet
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> p in <span class="k">$(</span>kubectl get pods --namespace<span class="o">=</span>kube-system -l k8s-app<span class="o">=</span>kube-dns -o name<span class="k">)</span><span class="p">;</span> <span class="k">do</span> kubectl logs --namespace<span class="o">=</span>kube-system <span class="nv">$p</span><span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></div><h5 id="coredns">coredns</h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl describe pod -n kube-system coredns-xxx
</span></span></code></pre></div><blockquote>
<p>network: open /run/flannel/subnet.env: no such file or directory</p>
</blockquote>
<p>手动在每个节点上创建</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo vi /run/flannel/subnet.env
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加入内容</span>
</span></span><span class="line"><span class="cl"><span class="nv">FLANNEL_NETWORK</span><span class="o">=</span>10.244.0.0/16
</span></span><span class="line"><span class="cl"><span class="nv">FLANNEL_SUBNET</span><span class="o">=</span>10.244.0.1/24
</span></span><span class="line"><span class="cl"><span class="nv">FLANNEL_MTU</span><span class="o">=</span><span class="m">1450</span>
</span></span><span class="line"><span class="cl"><span class="nv">FLANNEL_IPMASQ</span><span class="o">=</span><span class="nb">true</span>
</span></span></code></pre></div><blockquote>
<p>&ldquo;cni0&rdquo; already has an IP address different from 10.244.1.1/24</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo ip link delete cni0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 重启pod</span>
</span></span><span class="line"><span class="cl">$ kubectl delete pod xxx
</span></span></code></pre></div><blockquote>
<p>Readiness probe failed: HTTP probe failed with statuscode: 503</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ systemctl stop kubelet
</span></span><span class="line"><span class="cl">$ systemctl stop docker
</span></span><span class="line"><span class="cl">$ iptables --flush
</span></span><span class="line"><span class="cl">$ iptables -tnat --flush
</span></span><span class="line"><span class="cl">$ systemctl start kubelet
</span></span><span class="line"><span class="cl">$ systemctl start docker
</span></span></code></pre></div><h5 id="节点-not-ready">节点 not ready</h5>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png"
        data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png 2x"
        data-sizes="auto"
        alt="https://raw.githubusercontent.com/xuliangTang/picbeds/main/typora/image-20221203185744006.png"
        title="image-20221203185744006" /></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl describe node lain2
</span></span></code></pre></div><blockquote>
<p>failed to find plugin &ldquo;xxx&rdquo; in path [/opt/cni/bin]</p>
</blockquote>
<p>把master节点的 <code>/opt/cni/bin</code> 拷贝过来，在master节点执行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">cd</span> /opt/cni
</span></span><span class="line"><span class="cl">$ sudo scp -r bin root@192.168.0.105:/opt/cni/bin
</span></span></code></pre></div><p>原因可能是重装k8s的时候没有删除 <code>/etc/cni/net.d</code> 目录</p>
<h3 id="加入子节点">加入子节点</h3>
<p>在每个node节点执行刚刚初始化集群时生成的token</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo kubeadm join 192.168.0.111:6443 --token fnq8dx.doxwr7sctdm57p0t <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --discovery-token-ca-cert-hash sha256:114acfe6e30bc0181a93b9135296af62c5f946fa590691577071a4ebf21fc3ee
</span></span></code></pre></div><h3 id="查看集群健康状况">查看集群健康状况</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get cs
</span></span></code></pre></div><blockquote>
<p>controller-manager &amp;&amp; scheduler Unhealthy: dial tcp 127.0.0.1:10252 connection refuse</p>
</blockquote>
<p>在master节点执行</p>
<pre tabindex="0"><code>$ sudo vi /etc/kubernetes/manifests/kube-scheduler.yaml
$ sudo vi /etc/kubernetes/manifests/kube-controller-manager.yaml

# 注释
# - --port=0

# 重启kublet
$ systemctl restart kubelet
</code></pre><h2 id="将集群导入-rancher">将集群导入 Rancher</h2>
<p>找一个节点执行下载v2.6</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo docker run --privileged -d --restart<span class="o">=</span>unless-stopped -p 80:80 -p 443:443 rancher/rancher:v2.6-head
</span></span></code></pre></div><p>根据指引执行命令</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-12-03</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://example.org/posts/kubeadm/" data-title="使用 kubeadm 部署 k8s"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/posts/kubeadm/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://example.org/posts/kubeadm/" data-title="使用 kubeadm 部署 k8s"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.org/posts/kubeadm/" data-title="使用 kubeadm 部署 k8s"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://example.org/posts/kubeadm/" data-title="使用 kubeadm 部署 k8s"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
            <a href="/posts/rbac/" class="next" rel="next" title="K8s 认证和授权">K8s 认证和授权<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.101.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">xuliangTang</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
