<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>K8s list-watch 机制和 Informer 模块 - Lain Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="K8s list-watch 机制和 Informer 模块"><meta property="og:description" content="在 Kubernetes 中，有5个主要的组件，分别是 master 节点上的 kube-api-server、kube-controller-manager 和 kube-sche"><meta property="og:type" content="article"><meta property="og:url" content="http://xuliangtang.github.io/posts/k8s-list-watch/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-18T18:29:49+08:00"><meta property="article:modified_time" content="2022-12-21T17:01:09+08:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="K8s list-watch 机制和 Informer 模块"><meta name=twitter:description content="在 Kubernetes 中，有5个主要的组件，分别是 master 节点上的 kube-api-server、kube-controller-manager 和 kube-sche"><meta name=application-name content="Lain Blog"><meta name=apple-mobile-web-app-title content="Lain Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicons/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://xuliangtang.github.io/posts/k8s-list-watch/><link rel=prev href=http://xuliangtang.github.io/posts/k8s-go/><link rel=next href=http://xuliangtang.github.io/posts/k8s-pod-shell/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"K8s list-watch 机制和 Informer 模块","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/xuliangtang.github.io\/posts\/k8s-list-watch\/"},"genre":"posts","wordcount":2792,"url":"http:\/\/xuliangtang.github.io\/posts\/k8s-list-watch\/","datePublished":"2022-12-18T18:29:49+08:00","dateModified":"2022-12-21T17:01:09+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xuliangTang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Lain Blog">Dev Lain</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">K8s list-watch 机制和 Informer 模块</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xuliangTang</a></span>&nbsp;<span class=post-category>included in <a href=/categories/k8s-go/><i class="far fa-folder fa-fw" aria-hidden=true></i>k8s-go</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-12-18>2022-12-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2792 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;6 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#list-watch-机制>list-watch 机制</a></li><li><a href=#informer-机制>informer 机制</a></li><li><a href=#在-client-go-中的应用>在 client-go 中的应用</a><ul><li><a href=#sharedinformerfactory>SharedInformerFactory</a></li></ul></li><li><a href=#示例>示例</a><ul><li><a href=#监听-deployment>监听 deployment</a></li><li><a href=#获取-deployment-的关联-pod>获取 deployment 的关联 pod</a></li><li><a href=#获取-pod-状态和-event>获取 Pod 状态和 Event</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>在 Kubernetes 中，有5个主要的组件，分别是 master 节点上的 kube-api-server、kube-controller-manager 和 kube-scheduler，node 节点上的 kubelet 和kube-proxy 。这其中 kube-apiserver 是对外和对内提供资源的声明式 API 的组件，其它4个组件都需要和它交互。为了保证消息的实时性，有两种方式：</p><ul><li>客户端组件 (kubelet, scheduler, controller-manager 等) 轮询 apiserver</li><li>apiserver 通知客户端</li></ul><p>为了降低 kube-apiserver 的压力，有一个非常关键的机制就是 list-watch。list-watch 本质上也是 client 端监听 k8s 资源变化并作出相应处理的生产者消费者框架</p><p>list-watach 机制需要满足以下需求：</p><ol><li>实时性 (即数据变化时，相关组件越快感知越好)</li><li>保证消息的顺序性 (即消息要按发生先后顺序送达目的组件。很难想象在Pod创建消息前收到该Pod删除消息时组件应该怎么处理)</li><li>保证消息不丢失或者有可靠的重新获取机制 (比如 kubelet 和 kube-apiserver 间网络闪断，需要保证网络恢复后kubelet可以收到网络闪断期间产生的消息)</li></ol><h2 id=list-watch-机制>list-watch 机制</h2><p>list-watch 由两部分组成，分别是 list 和 watch。list 非常好理解，就是调用资源的 list API 罗列资源 ，基于 HTTP 短链接实现，watch 则是调用资源的 watch API 监听资源变更事件，基于 HTTP 长链接实现</p><p>etcd 存储集群的数据信息，apiserver 作为统一入口，任何对数据的操作都必须经过 apiserver。客户端通过 list-watch 监听 apiserver 中资源的 create, update 和 delete 事件，并针对事件类型调用相应的事件处理函数</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181854816.jpeg data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181854816.jpeg, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181854816.jpeg 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181854816.jpeg 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181854816.jpeg title=img></p><h2 id=informer-机制>informer 机制</h2><p>k8s 的 informer 模块封装 list-watch API，用户只需要指定资源，编写事件处理函数，AddFunc, UpdateFunc 和 DeleteFunc 等。如下图所示，informer 首先通过 list API 罗列资源，然后调用 watch API 监听资源的变更事件，并将结果放入到一个 FIFO 队列，队列的另一头有协程从中取出事件，并调用对应的注册函数处理事件。Informer 还维护了一个只读的 Map Store 缓存，主要为了提升查询的效率，降低 apiserver 的负载</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181902721.png data-srcset="https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181902721.png, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181902721.png 1.5x, https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181902721.png 2x" data-sizes=auto alt=https://raw.githubusercontent.com/xuliangTang/picbeds/main/picgo/202212181902721.png title=informer实现原理></p><h2 id=在-client-go-中的应用>在 client-go 中的应用</h2><p>client-go 使用 k8s.io/client-go/tools/cache 包里的 informer 对象进行 list-watch 机制的封装</p><p>最粗暴的解释：</p><ol><li>初始化时，调 List API 获得全量 list，缓存起来(本地缓存)，这样就不需要每次请求都去请求 ApiServer</li><li>调用 Watch API 去 watch 资源，发生变更后会通过一定机制维护缓存</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DepHandler</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DepHandler</span><span class=p>)</span> <span class=nf>OnAdd</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DepHandler</span><span class=p>)</span> <span class=nf>OnUpdate</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>dep</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>newObj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>dep</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DepHandler</span><span class=p>)</span> <span class=nf>OnDelete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>c</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewInformer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 监听 default 命名空间中 deployment 的变化
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>cache</span><span class=p>.</span><span class=nf>NewListWatchFromClient</span><span class=p>(</span><span class=nx>K8sClient</span><span class=p>.</span><span class=nf>AppsV1</span><span class=p>().</span><span class=nf>RESTClient</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=s>&#34;deployments&#34;</span><span class=p>,</span> <span class=s>&#34;default&#34;</span><span class=p>,</span> <span class=nx>fields</span><span class=p>.</span><span class=nf>Everything</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=mi>0</span><span class=p>,</span>				<span class=c1>// 重新同步时间
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>&amp;</span><span class=nx>DepHandler</span><span class=p>{},</span>	<span class=c1>// 实现类
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>select</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=sharedinformerfactory>SharedInformerFactory</h3><p>sharedInformerFactory 用来构造各种 Informer 的工厂对象，它可以共享多个 informer 资源</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>informerFactory</span> <span class=o>:=</span> <span class=nx>informers</span><span class=p>.</span><span class=nf>NewSharedInformerFactory</span><span class=p>(</span><span class=nx>K8sClient</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 构建一个 deployment informer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>depInformer</span> <span class=o>:=</span> <span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Apps</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Deployments</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>depInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>DepHandler</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>select</span> <span class=p>{}</span>
</span></span></code></pre></div><h2 id=示例>示例</h2><h3 id=监听-deployment>监听 deployment</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 全局对象，存储所有deployments
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>DepMapImpl</span> <span class=o>*</span><span class=nx>DeploymentMap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>DepMapImpl</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>DeploymentMap</span><span class=p>{</span><span class=nx>Data</span><span class=p>:</span> <span class=nb>new</span><span class=p>(</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Map</span><span class=p>)}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DeploymentMap</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Data</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Map</span>	<span class=c1>// key:namespace value:[]*v1.Deployments
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 添加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DeploymentMap</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>deployment</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>depList</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>depList</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>depList</span><span class=p>.([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>),</span> <span class=nx>deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>depList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{</span><span class=nx>deployment</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取列表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DeploymentMap</span><span class=p>)</span> <span class=nf>ListByNs</span><span class=p>(</span><span class=nx>namespace</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>depList</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=nx>namespace</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>depList</span><span class=p>.([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;record not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 更新
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DeploymentMap</span><span class=p>)</span> <span class=nf>Update</span><span class=p>(</span><span class=nx>deployment</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>depList</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>depList</span> <span class=o>:=</span> <span class=nx>depList</span><span class=p>.([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>dep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>depList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>dep</span><span class=p>.</span><span class=nx>Name</span> <span class=o>==</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>depList</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>deployment</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;deployment [%s] not found&#34;</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DeploymentMap</span><span class=p>)</span> <span class=nf>Delete</span><span class=p>(</span><span class=nx>deployment</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>depList</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>depList</span> <span class=o>:=</span> <span class=nx>depList</span><span class=p>.([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>dep</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>depList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>dep</span><span class=p>.</span><span class=nx>Name</span> <span class=o>==</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>newDepList</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>depList</span><span class=p>[:</span><span class=nx>i</span><span class=p>],</span> <span class=nx>depList</span><span class=p>[</span><span class=nx>i</span><span class=o>+</span><span class=mi>1</span><span class=p>:]</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>deployment</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>newDepList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// informer实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>DepHandler</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DepHandler</span><span class=p>)</span> <span class=nf>OnAdd</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>DepMapImpl</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DepHandler</span><span class=p>)</span> <span class=nf>OnUpdate</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>DepMapImpl</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=nx>newObj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>DepHandler</span><span class=p>)</span> <span class=nf>OnDelete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>DepMapImpl</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 执行监听
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>InitDeployments</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=o>:=</span> <span class=nx>informers</span><span class=p>.</span><span class=nf>NewSharedInformerFactory</span><span class=p>(</span><span class=nx>K8sClient</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>depInformer</span> <span class=o>:=</span> <span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Apps</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Deployments</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>depInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>DepHandler</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>wait</span><span class=p>.</span><span class=nx>NeverStop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=获取-deployment-的关联-pod>获取 deployment 的关联 pod</h3><p>之前做过利用 Deployment 的 MatchLabels 去匹配 pod 的 labels 的方式。这次我们利用 ReplicaSet 的标签去匹配 Pod，这种方式可以区分当多个 Deployment 的 Pod 设置为相同标签的场景</p><p>当创建完 Deployment 后，k8s 会创建对应的 ReplicaSet，它会根据 template 里的内容进行 hash，然后自动设置一个标签 <code>pod-template-hash</code>，且与它管理的所有 Pod 标签相对应</p><pre tabindex=0><code>Labels: app=xnginx
        pod-template-hash=767447889d
</code></pre><p>我们只需要通过 Deployment 获取它的 ReplicaSet，再拿 labels 去匹配 Pod</p><ul><li><p><strong>第一步</strong>：监听 Deployment、ReplicaSet 和 Pod，分别实现对应的 informer 方法，将数据缓存到本地</p></li><li><p><strong>第二步</strong>：通过 Deployment 获取对应的 ReplicaSet，拿到 labels</p></li></ul><p>关键代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 从本地缓存中取出所有的rs
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>rsList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>RSMapImpl</span><span class=p>.</span><span class=nf>ListByNs</span><span class=p>(</span><span class=nx>namespace</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取 labels
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>labels</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>GetListWatchRsLabelByDeployment</span><span class=p>(</span><span class=nx>deployment</span><span class=p>,</span> <span class=nx>rsList</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// list-watch方式 根据deployment获取当前ReplicaSet的标签
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GetListWatchRsLabelByDeployment</span><span class=p>(</span><span class=nx>deployment</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>,</span> <span class=nx>rsList</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>ReplicaSet</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>rs</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rsList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nf>IsCurrentRsByDeployment</span><span class=p>(</span><span class=nx>rs</span><span class=p>,</span> <span class=nx>deployment</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>selector</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>metaV1</span><span class=p>.</span><span class=nf>LabelSelectorAsMap</span><span class=p>(</span><span class=nx>rs</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Selector</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>selector</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 判断rs是否对应当前deployment
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>IsCurrentRsByDeployment</span><span class=p>(</span><span class=nx>set</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>ReplicaSet</span><span class=p>,</span> <span class=nx>deployment</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>set</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>[</span><span class=s>&#34;deployment.kubernetes.io/revision&#34;</span><span class=p>]</span> <span class=o>!=</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>.</span><span class=nx>Annotations</span><span class=p>[</span><span class=s>&#34;deployment.kubernetes.io/revision&#34;</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>rf</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>set</span><span class=p>.</span><span class=nx>OwnerReferences</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>Kind</span> <span class=o>==</span> <span class=s>&#34;Deployment&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>Name</span> <span class=o>==</span> <span class=nx>deployment</span><span class=p>.</span><span class=nx>Name</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><ul><li><strong>第三步</strong>：通过 labels 去匹配 pods</li></ul><p>关键代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 根据标签获取Pod列表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>PodMap</span><span class=p>)</span> <span class=nf>ListByLabels</span><span class=p>(</span><span class=nx>ns</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>labels</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ret</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>podList</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=nx>ns</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>podList</span> <span class=o>:=</span> <span class=nx>podList</span><span class=p>.([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>p</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 判断标签完全匹配
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>reflect</span><span class=p>.</span><span class=nf>DeepEqual</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>Labels</span><span class=p>,</span> <span class=nx>labels</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>ret</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>ret</span><span class=p>,</span> <span class=nx>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ret</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;pods not found&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=获取-pod-状态和-event>获取 Pod 状态和 Event</h3><p>Pod 状态信息包含：</p><ul><li><strong>阶段</strong>：Pod 的 status 字段是一个 PodStatus 对象，其中包含一个 phase 字段</li></ul><table><thead><tr><th style=text-align:left>取值</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left><code>Pending</code>（悬决）</td><td style=text-align:left>Pod 已被 Kubernetes 系统接受，但有一个或者多个容器尚未创建亦未运行。此阶段包括等待 Pod 被调度的时间和通过网络下载镜像的时间。</td></tr><tr><td style=text-align:left><code>Running</code>（运行中）</td><td style=text-align:left>Pod 已经绑定到了某个节点，Pod 中所有的容器都已被创建。至少有一个容器仍在运行，或者正处于启动或重启状态。</td></tr><tr><td style=text-align:left><code>Succeeded</code>（成功）</td><td style=text-align:left>Pod 中的所有容器都已成功终止，并且不会再重启。</td></tr><tr><td style=text-align:left><code>Failed</code>（失败）</td><td style=text-align:left>Pod 中的所有容器都已终止，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。</td></tr><tr><td style=text-align:left><code>Unknown</code>（未知）</td><td style=text-align:left>因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</td></tr></tbody></table><ul><li><strong>状况</strong>：PodStatus 对象包含一个 PodConditions 数组</li></ul><table><thead><tr><th style=text-align:left>字段名称</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left><code>type</code></td><td style=text-align:left>Pod 状况的名称</td></tr><tr><td style=text-align:left><code>status</code></td><td style=text-align:left>表明该状况是否适用，可能的取值有 &ldquo;<code>True</code>"、"<code>False</code>&rdquo; 或 &ldquo;<code>Unknown</code>&rdquo;</td></tr><tr><td style=text-align:left><code>lastProbeTime</code></td><td style=text-align:left>上次探测 Pod 状况时的时间戳</td></tr><tr><td style=text-align:left><code>lastTransitionTime</code></td><td style=text-align:left>Pod 上次从一种状态转换到另一种状态时的时间戳</td></tr><tr><td style=text-align:left><code>reason</code></td><td style=text-align:left>机器可读的、驼峰编码（UpperCamelCase）的文字，表述上次状况变化的原因</td></tr><tr><td style=text-align:left><code>message</code></td><td style=text-align:left>人类可读的消息，给出上次状态转换的详细信息</td></tr></tbody></table><blockquote><p><code>PodScheduled</code>：Pod 已经被调度到某节点</p><p><code>PodHasNetwork</code>：Pod 沙箱被成功创建并且配置了网络（Alpha 特性，必须被显式启用）</p><p><code>ContainersReady</code>：Pod 中所有容器都已就绪</p><p><code>Initialized</code>：所有的 Init 容器都已成功完成</p><p><code>Ready</code>：Pod 可以为请求提供服务，并且应该被添加到对应服务的负载均衡池中</p></blockquote><ul><li><strong>事件对象</strong>：为用户提供了洞察集群内发生的事情的能力。为了避免主节点磁盘空间被填满，将强制执行保留策略：事件在最后一次发生的一小时后将会被删除</li></ul><p>关键代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// EventMapImpl 全局对象，存储所有Event
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>var</span> <span class=nx>EventMapImpl</span> <span class=o>*</span><span class=nx>EventMap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>EventMapImpl</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>EventMap</span><span class=p>{</span><span class=nx>Data</span><span class=p>:</span> <span class=nb>new</span><span class=p>(</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Map</span><span class=p>)}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>EventMap</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Data</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Map</span> <span class=c1>// key:namespace_kind_name value: *v1.Event
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>EventMap</span><span class=p>)</span> <span class=nf>GetKey</span><span class=p>(</span><span class=nx>event</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s_%s_%s&#34;</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>InvolvedObject</span><span class=p>.</span><span class=nx>Kind</span><span class=p>,</span> <span class=nx>event</span><span class=p>.</span><span class=nx>InvolvedObject</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>key</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Add 添加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>EventMap</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>event</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>EventMapImpl</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>this</span><span class=p>.</span><span class=nf>GetKey</span><span class=p>(</span><span class=nx>event</span><span class=p>),</span> <span class=nx>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Delete 删除
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>EventMap</span><span class=p>)</span> <span class=nf>Delete</span><span class=p>(</span><span class=nx>event</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>EventMapImpl</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>this</span><span class=p>.</span><span class=nf>GetKey</span><span class=p>(</span><span class=nx>event</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取最新一条event message
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>EventMap</span><span class=p>)</span> <span class=nf>GetMessage</span><span class=p>(</span><span class=nx>ns</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>kind</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>key</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s_%s_%s&#34;</span><span class=p>,</span> <span class=nx>ns</span><span class=p>,</span> <span class=nx>kind</span><span class=p>,</span> <span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>this</span><span class=p>.</span><span class=nx>Data</span><span class=p>.</span><span class=nf>Load</span><span class=p>(</span><span class=nx>key</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>v</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>).</span><span class=nx>Message</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// EventHandler informer实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>EventHandler</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>EventHandler</span><span class=p>)</span> <span class=nf>OnAdd</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>EventMapImpl</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>EventHandler</span><span class=p>)</span> <span class=nf>OnUpdate</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>EventMapImpl</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>newObj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>this</span> <span class=o>*</span><span class=nx>EventHandler</span><span class=p>)</span> <span class=nf>OnDelete</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>EventMapImpl</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Event</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 评估Pod是否就绪
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GetPodIsReady</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>coreV1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>condition</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>condition</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=s>&#34;ContainersReady&#34;</span> <span class=o>&amp;&amp;</span> <span class=nx>condition</span><span class=p>.</span><span class=nx>Status</span> <span class=o>!=</span> <span class=s>&#34;True&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>rg</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>ReadinessGates</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>condition</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Conditions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>condition</span><span class=p>.</span><span class=nx>Type</span> <span class=o>==</span> <span class=nx>rg</span><span class=p>.</span><span class=nx>ConditionType</span> <span class=o>&amp;&amp;</span> <span class=nx>condition</span><span class=p>.</span><span class=nx>Status</span> <span class=o>!=</span> <span class=s>&#34;True&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取pods DTO 把原生的 pod 对象转换为自己的实体对象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>GetPodsByLabels</span><span class=p>(</span><span class=nx>ns</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>labels</span> <span class=p>[]</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>pods</span> <span class=p>[]</span><span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>PodModel</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>PodMapImpl</span><span class=p>.</span><span class=nf>ListByLabels</span><span class=p>(</span><span class=nx>ns</span><span class=p>,</span> <span class=nx>labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>lib</span><span class=p>.</span><span class=nf>CheckError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pods</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>model</span><span class=p>.</span><span class=nx>PodModel</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>podList</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pods</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>model</span><span class=p>.</span><span class=nx>PodModel</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>NodeName</span><span class=p>:</span>  <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Images</span><span class=p>:</span>    <span class=nf>GetPodImages</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>Containers</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Phase</span><span class=p>:</span>     <span class=nb>string</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>Phase</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>IsReady</span><span class=p>:</span>   <span class=nf>GetPodIsReady</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Message</span><span class=p>:</span>   <span class=nx>EventMapImpl</span><span class=p>.</span><span class=nf>GetMessage</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>,</span> <span class=s>&#34;Pod&#34;</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>CreatedAt</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>CreationTimestamp</span><span class=p>.</span><span class=nf>Format</span><span class=p>(</span><span class=s>&#34;2006-01-02 15:04:05&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-12-21&nbsp;<a class=git-hash href=https://github.com/xuliangTang/xuliangTang.github.io/commit/bdbf770d3fcd05ae35972c12ffc260da31747fda target=_blank title="commit by Lily(1297441127@qq.com) bdbf770d3fcd05ae35972c12ffc260da31747fda: update: k8s-list-watch">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>bdbf770</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://xuliangtang.github.io/posts/k8s-list-watch/ data-title="K8s list-watch 机制和 Informer 模块"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://xuliangtang.github.io/posts/k8s-list-watch/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://xuliangtang.github.io/posts/k8s-list-watch/ data-title="K8s list-watch 机制和 Informer 模块"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://xuliangtang.github.io/posts/k8s-list-watch/ data-title="K8s list-watch 机制和 Informer 模块"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://xuliangtang.github.io/posts/k8s-list-watch/ data-title="K8s list-watch 机制和 Informer 模块"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/k8s-go/ class=prev rel=prev title="K8s client-go"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>K8s client-go</a>
<a href=/posts/k8s-pod-shell/ class=next rel=next title=k8s远程进入容器terminal>k8s远程进入容器terminal<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.108.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>xuliangTang</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{},search:{algoliaAppID:"4ZKRIKL2L6",algoliaIndex:"dev_lain",algoliaSearchKey:"2da9b5e339083fde5fe030c2345f5499",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:80,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>